<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shorts Match - ãƒ­ã‚°ã‚¤ãƒ³ / ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); }
        .gradient-btn { background: linear-gradient(to right, #06b6d4, #3b82f6); }
        .tool-checkbox:checked + .tool-label {
            background: linear-gradient(to right, #06b6d4, #3b82f6);
            color: white; border-color: #06b6d4;
        }
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="gradient-bg min-h-screen">

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm">
        <div class="max-w-5xl mx-auto px-6 py-4 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2 font-bold text-xl text-cyan-600 hover:scale-105 transition-transform">
                â–¶ Shorts Match
            </a>
            <div id="headerNav" class="flex items-center gap-3">
                <a href="index.html" class="text-sm font-bold text-slate-500 hover:text-cyan-600 transition-colors">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸</a>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto px-6 py-12">

        <div id="authSection" class="fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 gradient-btn rounded-2xl flex items-center justify-center text-white text-2xl mx-auto mb-4">âœï¸</div>
                <h1 class="text-3xl font-black text-slate-800 mb-2">ç·¨é›†è€…ãƒãƒ¼ã‚¿ãƒ«</h1>
                <p class="text-slate-500">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç®¡ç†ã—ã¾ã—ã‚‡ã†</p>
            </div>

            <div class="bg-white rounded-3xl shadow-xl p-8">
                <div class="flex rounded-2xl bg-slate-100 p-1 mb-8">
                    <button id="tabLogin" onclick="switchTab('login')" class="flex-1 py-2.5 rounded-xl font-bold text-sm transition-all bg-white text-slate-800 shadow-sm">ãƒ­ã‚°ã‚¤ãƒ³</button>
                    <button id="tabRegister" onclick="switchTab('register')" class="flex-1 py-2.5 rounded-xl font-bold text-sm transition-all text-slate-500">æ–°è¦ç™»éŒ²</button>
                </div>

                <div id="loginForm">
                    <div class="mb-5">
                        <label class="block text-sm font-bold text-slate-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input id="loginEmail" type="email" placeholder="example@email.com" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-cyan-400 focus:outline-none bg-slate-50 focus:bg-white transition-all">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-slate-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input id="loginPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-cyan-400 focus:outline-none bg-slate-50 focus:bg-white transition-all">
                    </div>
                    <div id="loginError" class="text-red-500 text-sm mb-4 hidden font-bold"></div>
                    <button onclick="handleLogin()" class="w-full gradient-btn text-white py-4 rounded-2xl font-bold text-lg hover:opacity-90 hover:scale-[1.02] transition-all shadow-lg shadow-cyan-200">ãƒ­ã‚°ã‚¤ãƒ³</button>
                </div>

                <div id="registerForm" class="hidden">
                    <div class="mb-5">
                        <label class="block text-sm font-bold text-slate-700 mb-2">ãŠåå‰ï¼ˆè¡¨ç¤ºåï¼‰ <span class="text-red-400">*</span></label>
                        <input id="regName" type="text" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-cyan-400 focus:outline-none bg-slate-50 focus:bg-white transition-all">
                    </div>
                    <div class="mb-5">
                        <label class="block text-sm font-bold text-slate-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="text-red-400">*</span></label>
                        <input id="regEmail" type="email" placeholder="example@email.com" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-cyan-400 focus:outline-none bg-slate-50 focus:bg-white transition-all">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-slate-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span class="text-red-400">*</span>ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰</label>
                        <input id="regPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-cyan-400 focus:outline-none bg-slate-50 focus:bg-white transition-all">
                    </div>
                    <div id="registerError" class="text-red-500 text-sm mb-4 hidden font-bold"></div>
                    <button onclick="handleRegister()" class="w-full gradient-btn text-white py-4 rounded-2xl font-bold text-lg hover:opacity-90 hover:scale-[1.02] transition-all shadow-lg shadow-cyan-200">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ</button>
                </div>
            </div>
        </div>

        <div id="mypageSection" class="hidden fade-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 rounded-2xl mx-auto mb-4 overflow-hidden border-4 border-white shadow-lg bg-slate-100 flex items-center justify-center text-2xl" id="mypageAvatar">ğŸ‘¤</div>
                <h1 class="text-2xl font-black text-slate-800" id="mypageName">èª­ã¿è¾¼ã¿ä¸­...</h1>
                <p class="text-cyan-500 font-bold text-sm mt-1" id="mypageEmail"></p>
            </div>

            <div class="bg-white rounded-3xl shadow-xl p-8 mb-6">
                <h2 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                    <span class="w-8 h-8 gradient-btn rounded-lg flex items-center justify-center text-white text-sm">âœï¸</span>
                    ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
                </h2>
                <div class="space-y-5">
                    <input type="text" id="mpName" placeholder="è¡¨ç¤ºå" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none focus:border-cyan-400">
                    <input type="text" id="mpPrice" placeholder="å˜ä¾¡ç›®å®‰ (ä¾‹: Â¥3,000ã€œ)" class="w-full p-4 bg-slate-50 rounded-2xl border outline-none focus:border-cyan-400">
                    <button onclick="handleUpdate()" class="w-full gradient-btn text-white py-4 rounded-2xl font-bold text-lg hover:opacity-90 hover:scale-[1.02] transition-all">ä¿å­˜ã™ã‚‹</button>
                    <div id="mypageStatus" class="text-emerald-500 text-center font-bold hidden"></div>
                </div>
            </div>
            <button onclick="handleLogout()" class="w-full bg-white text-slate-500 py-3 rounded-2xl font-bold border-2 border-slate-200 hover:text-red-500 transition-all">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://dwmgwdhunvanrsautvtj.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GzaEGCWBP7y0za2UVPiJNA_N3pdlgJ0';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        window.addEventListener('load', async () => {
            const { data: { session } } = await sb.auth.getSession();
            if (session) { loadMypage(session.user); } else { showAuth(); }
        });

        function switchTab(tab) {
            const isLogin = tab === 'login';
            document.getElementById('loginForm').classList.toggle('hidden', !isLogin);
            document.getElementById('registerForm').classList.toggle('hidden', isLogin);
            document.getElementById('tabLogin').className = isLogin ? 'flex-1 py-2.5 rounded-xl font-bold text-sm bg-white text-slate-800 shadow-sm' : 'flex-1 py-2.5 rounded-xl font-bold text-sm text-slate-500';
            document.getElementById('tabRegister').className = !isLogin ? 'flex-1 py-2.5 rounded-xl font-bold text-sm bg-white text-slate-800 shadow-sm' : 'flex-1 py-2.5 rounded-xl font-bold text-sm text-slate-500';
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errEl = document.getElementById('loginError');
            const { data, error } = await sb.auth.signInWithPassword({ email, password });
            if (error) { errEl.textContent = 'âŒ ' + error.message; errEl.classList.remove('hidden'); } else { loadMypage(data.user); }
        }

        async function handleRegister() {
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const name = document.getElementById('regName').value.trim();
            const errEl = document.getElementById('registerError');
            
            if (!name) { errEl.textContent = 'âš ï¸ ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; errEl.classList.remove('hidden'); return; }

            const { data, error: authError } = await sb.auth.signUp({ email, password });
            if (authError) { errEl.textContent = 'âŒ ' + authError.message; errEl.classList.remove('hidden'); return; }

            if (data.user) {
                // åå‰ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
                await sb.from('editors').upsert({ id: data.user.id, name: name });
                alert('ç™»éŒ²å®Œäº†ã—ã¾ã—ãŸï¼');
                loadMypage(data.user);
            }
        }

        async function loadMypage(user) {
            showMypage();
            document.getElementById('mypageEmail').textContent = user.email;
            const { data } = await sb.from('editors').select('*').filter('id::text', 'eq', user.id).maybeSingle();
            if (data) {
                document.getElementById('mypageName').textContent = data.name || 'æœªè¨­å®š';
                document.getElementById('mpName').value = data.name || '';
                document.getElementById('mpPrice').value = data.price || '';
            }
        }
// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°å‡¦ç†ï¼ˆä¸Šæ›¸ããƒ»ä½œæˆä¸¡å¯¾å¿œç‰ˆï¼‰
        async function handleUpdate() {
            const statusEl = document.getElementById('mypageStatus');
            statusEl.classList.remove('hidden', 'text-emerald-500', 'text-red-500');
            statusEl.textContent = 'ä¿å­˜ä¸­...';

            const { data: { user } } = await sb.auth.getUser();
            if (!user) {
                statusEl.textContent = 'âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ‡ã‚Œã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„';
                statusEl.classList.add('text-red-500');
                statusEl.classList.remove('hidden');
                return;
            }

            const updates = {
                id: user.id,
                name: document.getElementById('mpName').value.trim(),
                price: document.getElementById('mpPrice').value.trim()
            };

            // .update ã§ã¯ãªã .upsert (ã‚¢ãƒƒãƒ—ã‚µãƒ¼ãƒˆ) ã‚’ä½¿ã†ã®ãŒã‚³ãƒ„ã§ã™
            const { error } = await sb
                .from('editors')
                .upsert(updates, { onConflict: 'id' });

            if (error) {
                console.error('Save error:', error);
                statusEl.textContent = 'âŒ ä¿å­˜å¤±æ•—: ' + error.message;
                statusEl.classList.add('text-red-500');
                statusEl.classList.remove('hidden');
            } else {
                statusEl.textContent = 'âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼';
                statusEl.classList.add('text-emerald-500');
                statusEl.classList.remove('hidden');
                document.getElementById('mypageName').textContent = updates.name;
                setTimeout(() => statusEl.classList.add('hidden'), 3000);
            }
        }        
        }

        async function handleLogout() { await sb.auth.signOut(); showAuth(); }
        function showAuth() { document.getElementById('authSection').classList.remove('hidden'); document.getElementById('mypageSection').classList.add('hidden'); }
        function showMypage() { document.getElementById('authSection').classList.add('hidden'); document.getElementById('mypageSection').classList.remove('hidden'); }
    </script>
</body>
</html>
