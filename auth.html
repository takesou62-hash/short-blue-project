<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shorts Match - ログイン / マイページ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); }
        .gradient-text {
            background: linear-gradient(to right, #06b6d4, #3b82f6);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .gradient-btn { background: linear-gradient(to right, #06b6d4, #3b82f6); }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">

    <div id="authSection" class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8 fade-in">
        <h1 class="text-3xl font-black text-center mb-8 gradient-text tracking-tighter">Shorts Match</h1>
        <div class="space-y-4">
            <input type="email" id="email" placeholder="メールアドレス" class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-cyan-500 outline-none transition-all">
            <input type="password" id="password" placeholder="パスワード" class="w-full px-5 py-4 bg-slate-50 border border-slate-100 rounded-2xl focus:ring-2 focus:ring-cyan-500 outline-none transition-all">
            <div id="authError" class="text-red-500 text-sm hidden"></div>
            <button onclick="handleAuth()" id="authBtn" class="w-full py-4 rounded-2xl text-white font-bold gradient-btn shadow-lg shadow-cyan-200 hover:scale-[1.02] transition-all">ログイン / 新規登録</button>
        </div>
    </div>

    <div id="mypageSection" class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl p-8 hidden fade-in">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold text-slate-800">プロフィール編集</h2>
            <button onclick="handleLogout()" class="text-slate-400 text-sm hover:text-red-500">ログアウト</button>
        </div>
        <div class="space-y-6">
            <input type="text" id="name" placeholder="表示名" class="w-full p-4 bg-slate-50 rounded-2xl border">
            <input type="text" id="tools" placeholder="使用ソフト" class="w-full p-4 bg-slate-50 rounded-2xl border">
            <input type="number" id="price" placeholder="単価目安" class="w-full p-4 bg-slate-50 rounded-2xl border">
            <div id="statusMsg" class="text-emerald-500 text-sm hidden text-center"></div>
            <button onclick="saveProfile()" class="w-full py-4 rounded-2xl text-white font-bold gradient-btn">設定を保存する</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://dwmgwdhunvanrsautvtj.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GzaEGCWBP7y0za2UVPiJNA_N3pdlgJ0';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ログイン状態監視
        sb.auth.onAuthStateChanged((event, session) => {
            if (session) {
                showMypage();
                loadProfile(session.user.id);
            } else {
                showAuth();
            }
        });

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // まずはログイン試行
            let { data, error } = await sb.auth.signInWithPassword({ email, password });
            
            // ユーザーがいなければ新規登録
            if (error && error.message.includes('Invalid login credentials')) {
                const signup = await sb.auth.signUp({ email, password });
                error = signup.error;
            }

            if (error) {
                const errEl = document.getElementById('authError');
                errEl.textContent = '❌ ' + error.message;
                errEl.classList.remove('hidden');
            }
        }

        async function loadProfile(uid) {
            // SQLで設定したキャストに合わせて text で比較
            const { data } = await sb.from('editors').select('*').filter('id::text', 'eq', uid).single();
            if (data) {
                document.getElementById('name').value = data.name || '';
                document.getElementById('tools').value = data.tools || '';
                document.getElementById('price').value = data.price || '';
            }
        }

        async function saveProfile() {
            const { data: { user } } = await sb.auth.getUser();
            const updates = {
                name: document.getElementById('name').value,
                tools: document.getElementById('tools').value,
                price: document.getElementById('price').value,
            };

            const { error } = await sb.from('editors').update(updates).filter('id::text', 'eq', user.id);
            
            const msgEl = document.getElementById('statusMsg');
            if (!error) {
                msgEl.textContent = '✅ 保存しました！';
                msgEl.classList.remove('hidden');
                setTimeout(() => msgEl.classList.add('hidden'), 3000);
            }
        }

        async function handleLogout() { await sb.auth.signOut(); }
        function showAuth() { document.getElementById('authSection').classList.remove('hidden'); document.getElementById('mypageSection').classList.add('hidden'); }
        function showMypage() { document.getElementById('authSection').classList.add('hidden'); document.getElementById('mypageSection').classList.remove('hidden'); }
    </script>
</body>
</html>
