-- ============================================
-- users テーブル作成 + role カラム設定
-- Supabase > SQL Editor に貼り付けて実行
-- ============================================

-- 1. users テーブル作成（roleを持つ）
CREATE TABLE IF NOT EXISTS public.users (
    id         uuid        PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    name       text,
    role       text        NOT NULL DEFAULT 'client' CHECK (role IN ('editor', 'client')),
    avatar_url text,
    created_at timestamptz DEFAULT now()
);

-- 2. RLS 有効化
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;

-- 3. 誰でも読める（編集者一覧表示のため）
CREATE POLICY "users_select_all"
ON public.users FOR SELECT TO authenticated
USING (true);

-- 4. 自分のレコードだけ更新可
CREATE POLICY "users_insert_own"
ON public.users FOR INSERT TO authenticated
WITH CHECK (auth.uid() = id);

CREATE POLICY "users_update_own"
ON public.users FOR UPDATE TO authenticated
USING (auth.uid() = id);

-- 5. 既存の editors ユーザーを editor ロールで移行
INSERT INTO public.users (id, name, role)
SELECT id, name, 'editor'
FROM public.editors
ON CONFLICT (id) DO UPDATE SET role = 'editor', name = EXCLUDED.name;

-- 6. 確認
SELECT id, name, role, created_at FROM public.users LIMIT 10;
