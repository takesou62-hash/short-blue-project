<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shorts Match - ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 60%, #e0e7ff 100%); }
        .gradient-btn { background: linear-gradient(135deg, #06b6d4, #3b82f6); }
        .gradient-text { background: linear-gradient(135deg, #06b6d4, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .card { background: white; border-radius: 24px; box-shadow: 0 4px 24px rgba(0,0,0,0.07); }
        .fade-in { animation: fadeIn 0.5s ease both; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }
        .slide-down { animation: slideDown 0.3s ease both; }
        @keyframes slideDown { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:translateY(0); } }
        .tool-chip input[type=checkbox] { display:none; }
        .tool-chip input:checked + label {
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            color: white; border-color: transparent;
            box-shadow: 0 2px 8px rgba(6,182,212,0.4);
        }
        .tool-chip label {
            display: inline-block; padding: 6px 14px; border-radius: 20px;
            border: 2px solid #e2e8f0; background: #f8fafc;
            color: #475569; font-size: 13px; font-weight: 700;
            cursor: pointer; transition: all 0.2s; user-select: none;
        }
        .tool-chip label:hover { border-color: #06b6d4; color: #06b6d4; }
        .genre-chip input[type=checkbox] { display:none; }
        .genre-chip input:checked + label {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
            color: white; border-color: transparent;
        }
        .genre-chip label {
            display: inline-block; padding: 6px 14px; border-radius: 20px;
            border: 2px solid #e2e8f0; background: #f8fafc;
            color: #475569; font-size: 13px; font-weight: 700;
            cursor: pointer; transition: all 0.2s; user-select: none;
        }
        .tab-active { background: white; color: #1e293b; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .tab-inactive { color: #94a3b8; }
        .avatar-ring {
            border: 4px solid white;
            box-shadow: 0 0 0 3px #06b6d4, 0 8px 24px rgba(6,182,212,0.3);
        }
        .preview-card {
            background: white; border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            overflow: hidden; transition: transform 0.3s;
        }
        .preview-card:hover { transform: translateY(-4px); }
        .thumb-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .thumb-item {
            position: relative; border-radius: 10px; overflow: hidden; aspect-ratio: 9/16;
            transform: translateY(0); transition: transform 0.25s ease, box-shadow 0.25s ease;
            cursor: pointer;
        }
        .thumb-item:hover { transform: translateY(-6px); box-shadow: 0 12px 32px rgba(6,182,212,0.25); }
        .thumb-item img { width:100%; height:100%; object-fit:cover; transition: opacity 0.2s; }
        .thumb-item:hover img.thumb-static { opacity: 0; }
        .thumb-item video.thumb-video {
            position: absolute; inset: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0; transition: opacity 0.3s;
            pointer-events: none;
        }
        .thumb-item:hover video.thumb-video { opacity: 1; }
        .thumb-play {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.3); opacity: 0; transition: opacity 0.2s;
        }
        .thumb-item:hover .thumb-play { opacity: 1; }

        /* ===== ãƒãƒ£ãƒƒãƒˆUI ===== */
        .chat-bubble-wrap { display: flex; flex-direction: column; gap: 12px; }
        .chat-row { display: flex; align-items: flex-end; gap: 8px; max-width: 85%; }
        .chat-row.me { flex-direction: row-reverse; margin-left: auto; }
        .chat-row:not(.me) { margin-right: auto; }
        .chat-avatar-sm { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; border: 2px solid white; box-shadow: 0 1px 4px rgba(0,0,0,0.12); }
        .chat-msg-group { display: flex; flex-direction: column; gap: 2px; }
        .chat-sender-name { font-size: 11px; font-weight: 700; color: #94a3b8; margin-bottom: 3px; padding: 0 4px; }
        .chat-row.me .chat-sender-name { text-align: right; color: #06b6d4; }
        .chat-bubble {
            max-width: 100%; padding: 10px 14px; border-radius: 18px;
            font-size: 14px; line-height: 1.6; word-break: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .chat-bubble.them {
            background: #f1f5f9; color: #1e293b;
            border-bottom-left-radius: 5px;
        }
        .chat-bubble.me {
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            color: white; border-bottom-right-radius: 5px;
        }
        .chat-time { font-size: 10px; color: #94a3b8; margin-top: 3px; padding: 0 4px; }
        .chat-row.me .chat-time { text-align: right; }
        .chat-date-divider {
            text-align: center; font-size: 11px; font-weight: 700;
            color: #94a3b8; padding: 8px 0;
            display: flex; align-items: center; gap: 8px;
        }
        .chat-date-divider::before, .chat-date-divider::after {
            content: ''; flex: 1; height: 1px; background: #e2e8f0;
        }
        .chat-input-area {
            border-top: 2px solid #f1f5f9;
            padding: 12px 16px; display: flex; gap: 10px; align-items: flex-end;
            background: white;
        }
        .chat-input-area textarea {
            flex: 1; resize: none; border: 2px solid #e2e8f0; border-radius: 16px;
            padding: 10px 14px; font-size: 14px; outline: none; font-family: inherit;
            transition: border-color 0.2s; max-height: 120px; line-height: 1.5;
        }
        .chat-input-area textarea:focus { border-color: #06b6d4; }
        .chat-send-btn {
            width: 42px; height: 42px; border-radius: 14px; border: none; flex-shrink: 0;
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            color: white; font-size: 18px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.2s, transform 0.15s;
        }
        .chat-send-btn:hover { opacity: 0.88; transform: scale(1.07); }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; min-height: 200px; max-height: 420px; }
        .section-tab { cursor: pointer; padding: 10px 20px; border-radius: 12px; font-weight: 700; font-size: 14px; transition: all 0.2s; }
        .section-tab.active { background: linear-gradient(135deg, #06b6d4, #3b82f6); color: white; }
        .section-tab:not(.active) { color: #64748b; }
        .section-tab:not(.active):hover { background: #f1f5f9; }
        input[type=text], input[type=url], input[type=email], input[type=password] {
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, textarea:focus {
            box-shadow: 0 0 0 3px rgba(6,182,212,0.15);
        }
        @media (min-width: 768px) {
            .mypage-layout { display: grid; grid-template-columns: 300px 1fr; gap: 24px; align-items: start; }
        }
        /* ç¨¼åƒçŠ¶æ³ã‚«ãƒ¼ãƒ‰ */
        .availability-card input:checked + div { box-shadow: 0 0 0 3px currentColor; }
        .availability-card input[value="å—ä»˜ä¸­"]:checked + div  { border-color: #10b981 !important; box-shadow: 0 0 0 3px rgba(16,185,129,0.25); }
        .availability-card input[value="æ··é›‘ä¸­"]:checked + div  { border-color: #f59e0b !important; box-shadow: 0 0 0 3px rgba(245,158,11,0.25); }
        .availability-card input[value="å—ä»˜åœæ­¢"]:checked + div { border-color: #ef4444 !important; box-shadow: 0 0 0 3px rgba(239,68,68,0.25); }
        /* ç¨¼åƒãƒãƒƒã‚¸ï¼ˆindex.htmlå…±é€šï¼‰ */
        .avail-badge { display:inline-flex; align-items:center; gap:4px; font-size:11px; font-weight:700; padding:3px 10px; border-radius:20px; }
        .avail-open  { background:#d1fae5; color:#065f46; }
        .avail-busy  { background:#fef3c7; color:#92400e; }
        .avail-stop  { background:#fee2e2; color:#991b1b; }
        .role-card input:checked + div { border-color: #06b6d4 !important; background: #ecfeff !important; box-shadow: 0 0 0 3px rgba(6,182,212,0.2); }
        .role-card div:hover { border-color: #06b6d4 !important; }
        /* ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ãŠæ°—ã«å…¥ã‚Šã‚«ãƒ¼ãƒ‰ */
        .fav-editor-card { background: white; border-radius: 18px; padding: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); transition: transform 0.2s, box-shadow 0.2s; }
        .fav-editor-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(6,182,212,0.15); }
        /* ç›¸è«‡ä¸­ã‚¹ãƒ¬ãƒƒãƒ‰ã‚«ãƒ¼ãƒ‰ */
        .thread-card { background: white; border-radius: 18px; padding: 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .thread-card:hover { border-color: #06b6d4; box-shadow: 0 4px 16px rgba(6,182,212,0.18); }
        .unread-dot { width: 8px; height: 8px; background: #06b6d4; border-radius: 50%; flex-shrink: 0; }
    </style>
</head>
<body class="gradient-bg min-h-screen">

<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-slate-100">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
        <a href="index.html" class="flex items-center gap-2 group">
            <div class="w-8 h-8 gradient-btn rounded-lg flex items-center justify-center text-white text-sm font-black shadow group-hover:scale-110 transition-transform">â–¶</div>
            <span class="font-black text-xl text-cyan-600">Shorts Match</span>
        </a>
        <div class="flex items-center gap-3">
            <span id="headerEmail" class="text-xs text-slate-400 hidden md:block"></span>
            <a href="index.html" class="text-sm font-bold text-slate-500 hover:text-cyan-600 transition-colors px-3 py-1.5 rounded-lg hover:bg-cyan-50">â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
        </div>
    </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-8">

    <!-- ===== ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ² ===== -->
    <div id="authSection" class="max-w-md mx-auto fade-in">
        <div class="text-center mb-8">
            <div class="w-16 h-16 gradient-btn rounded-2xl flex items-center justify-center text-white text-2xl mx-auto mb-4 shadow-lg shadow-cyan-200">â–¶</div>
            <h1 class="text-3xl font-black text-slate-800 mb-2">Shorts Match</h1>
            <p class="text-slate-500">ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯æ–°è¦ç™»éŒ²ã‚’ã—ã¦ãã ã•ã„</p>
        </div>
        <div class="card p-8">
            <div class="flex rounded-2xl bg-slate-100 p-1 mb-8">
                <button id="tabLogin" onclick="switchTab('login')" class="flex-1 py-2.5 rounded-xl font-bold text-sm transition-all tab-active">ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button id="tabRegister" onclick="switchTab('register')" class="flex-1 py-2.5 rounded-xl font-bold text-sm transition-all tab-inactive">æ–°è¦ç™»éŒ²</button>
            </div>
            <!-- ãƒ­ã‚°ã‚¤ãƒ³ -->
            <div id="loginForm" class="space-y-4">
                <input id="loginEmail" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"
                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl outline-none focus:border-cyan-400 bg-slate-50">
                <input id="loginPassword" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl outline-none focus:border-cyan-400 bg-slate-50">
                <div id="loginMsg" class="hidden text-sm font-bold px-4 py-3 rounded-xl"></div>
                <button onclick="handleLogin()" class="w-full gradient-btn text-white py-4 rounded-2xl font-bold shadow-lg shadow-cyan-200 hover:scale-[1.02] hover:opacity-90 transition-all">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
            <!-- æ–°è¦ç™»éŒ² -->
            <div id="registerForm" class="hidden space-y-4">
                <!-- ãƒ­ãƒ¼ãƒ«é¸æŠ -->
                <div class="grid grid-cols-2 gap-3">
                    <label class="role-card cursor-pointer" id="roleCardClient">
                        <input type="radio" name="regRole" value="client" class="hidden" checked>
                        <div class="border-2 border-cyan-400 bg-cyan-50 rounded-2xl p-4 text-center transition-all">
                            <div class="text-3xl mb-2">ğŸ¬</div>
                            <div class="font-black text-sm text-slate-800">ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼</div>
                            <div class="text-xs text-slate-500 mt-1">å‹•ç”»åˆ¶ä½œã‚’ä¾é ¼ã—ãŸã„</div>
                        </div>
                    </label>
                    <label class="role-card cursor-pointer" id="roleCardEditor">
                        <input type="radio" name="regRole" value="editor" class="hidden">
                        <div class="border-2 border-slate-200 bg-slate-50 rounded-2xl p-4 text-center transition-all">
                            <div class="text-3xl mb-2">âœï¸</div>
                            <div class="font-black text-sm text-slate-800">ç·¨é›†è€…</div>
                            <div class="text-xs text-slate-500 mt-1">å‹•ç”»ç·¨é›†ã‚’å—æ³¨ã—ãŸã„</div>
                        </div>
                    </label>
                </div>
                <input id="regName" type="text" placeholder="ãŠåå‰ï¼ˆè¡¨ç¤ºåï¼‰"
                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl outline-none focus:border-cyan-400 bg-slate-50">
                <input id="regEmail" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"
                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl outline-none focus:border-cyan-400 bg-slate-50">
                <input id="regPassword" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰"
                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl outline-none focus:border-cyan-400 bg-slate-50">
                <input id="regPasswordConfirm" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªï¼‰"
                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl outline-none focus:border-cyan-400 bg-slate-50">
                <div id="registerMsg" class="hidden text-sm font-bold px-4 py-3 rounded-xl"></div>
                <button onclick="handleRegister()" class="w-full gradient-btn text-white py-4 rounded-2xl font-bold shadow-lg shadow-cyan-200 hover:scale-[1.02] hover:opacity-90 transition-all">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ</button>
            </div>
        </div>
    </div>

    <!-- ===== ãƒã‚¤ãƒšãƒ¼ã‚¸ ===== -->
    <div id="mypageSection" class="hidden fade-in">
        <div class="mypage-layout">

            <!-- å·¦ã‚«ãƒ©ãƒ ï¼šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ï¼‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="space-y-5">

                <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ -->
                <div class="card p-6 text-center">
                    <!-- ã‚¢ãƒã‚¿ãƒ¼ -->
                    <div class="relative inline-block mb-4">
                        <img id="avatarImg" src="" alt="avatar"
                            class="w-24 h-24 rounded-2xl avatar-ring object-cover mx-auto">
                        <div class="absolute -bottom-1 -right-1 w-7 h-7 gradient-btn rounded-full flex items-center justify-center text-white text-xs shadow cursor-pointer"
                            onclick="document.getElementById('imageUrlInput').focus()">âœï¸</div>
                    </div>
                    <h2 class="text-xl font-black text-slate-800 mt-3" id="mypageName">èª­ã¿è¾¼ã¿ä¸­...</h2>
                    <p class="text-cyan-500 font-bold text-sm mt-1" id="mypageEmail"></p>
                    <!-- ãƒ„ãƒ¼ãƒ«ãƒãƒƒã‚¸ -->
                    <div id="profileToolBadges" class="flex flex-wrap gap-1.5 justify-center mt-3"></div>
                    <!-- å˜ä¾¡ -->
                    <div id="profilePrice" class="mt-3 text-2xl font-black gradient-text"></div>
                    <button onclick="handleLogout()"
                        class="mt-4 w-full text-slate-400 text-sm py-2.5 rounded-xl border-2 border-slate-100 hover:text-red-500 hover:border-red-100 transition-all font-bold">
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </div>

                <!-- å®Ÿç¸¾ãƒ»è©•ä¾¡ã‚«ãƒ¼ãƒ‰ -->
                <div class="card p-5">
                    <h3 class="font-black text-slate-700 text-sm mb-4 flex items-center gap-2">
                        ğŸ“Š å®Ÿç¸¾ãƒ»è©•ä¾¡
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <!-- æ¡ˆä»¶æ•° -->
                        <div class="bg-cyan-50 rounded-2xl p-4 text-center">
                            <div class="text-3xl font-black gradient-text" id="statsProjects">-</div>
                            <div class="text-xs font-bold text-slate-400 mt-1">å—æ³¨æ¡ˆä»¶æ•°</div>
                        </div>
                        <!-- è©•ä¾¡ -->
                        <div class="bg-amber-50 rounded-2xl p-4 text-center">
                            <div class="text-3xl font-black text-amber-500" id="statsRating">-</div>
                            <div class="text-xs font-bold text-slate-400 mt-1">å¹³å‡è©•ä¾¡ â­</div>
                        </div>
                    </div>
                    <p class="text-xs text-slate-400 text-center mt-3">å®Ÿç¸¾ãƒ»è©•ä¾¡ã¯ç®¡ç†è€…ãŒæ›´æ–°ã—ã¾ã™</p>
                </div>

                <!-- å…¬é–‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                <div class="card p-5">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-base font-black text-slate-700">ğŸ‘ å…¬é–‹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
                        <span class="text-xs bg-cyan-100 text-cyan-600 font-bold px-2 py-0.5 rounded-full">ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è¦‹ãŸå§¿</span>
                    </div>
                    <div class="preview-card">
                        <div class="h-1.5 bg-gradient-to-r from-cyan-400 to-blue-500"></div>
                        <div class="p-4">
                            <div class="flex items-center gap-3 mb-3">
                                <img id="previewAvatar" src="" class="w-12 h-12 rounded-xl object-cover border-2 border-cyan-100">
                                <div>
                                    <div class="font-black text-slate-800 text-sm" id="previewName">æœªè¨­å®š</div>
                                    <div class="text-xs text-cyan-500 font-bold" id="previewGenres">å¾—æ„ã‚¸ãƒ£ãƒ³ãƒ«æœªè¨­å®š</div>
                                </div>
                            </div>
                            <div id="previewTools" class="flex flex-wrap gap-1 mb-3"></div>
                            <div class="flex justify-between items-center pt-2 border-t border-slate-50">
                                <div class="text-xs text-slate-400">å˜ä¾¡ç›®å®‰</div>
                                <div class="font-black text-cyan-600 text-sm" id="previewPrice">æœªè¨­å®š</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- å³ã‚«ãƒ©ãƒ ï¼šã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="space-y-5">

                <!-- ã‚¿ãƒ–ãƒŠãƒ“ -->
                <div class="card p-2 flex gap-1 flex-wrap">
                    <button class="section-tab active" onclick="switchSection('profile', this)">ğŸ“ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</button>
                    <button class="section-tab" onclick="switchSection('portfolio', this)">ğŸ¬ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª</button>
                    <button class="section-tab" onclick="switchSection('chat', this)">ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</button>
                </div>

                <!-- ===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›† ===== -->
                <div id="sectionProfile" class="card p-7 space-y-6">

                    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ -->
                    <div>
                        <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-3">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ</label>

                        <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ -->
                        <div id="uploadArea"
                            class="relative border-2 border-dashed border-slate-200 rounded-2xl p-6 text-center cursor-pointer hover:border-cyan-400 hover:bg-cyan-50/30 transition-all group"
                            onclick="document.getElementById('avatarFileInput').click()"
                            ondragover="event.preventDefault(); this.classList.add('border-cyan-400','bg-cyan-50/30')"
                            ondragleave="this.classList.remove('border-cyan-400','bg-cyan-50/30')"
                            ondrop="handleDrop(event)">
                            <!-- ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ï¼ˆéè¡¨ç¤ºï¼‰ -->
                            <input type="file" id="avatarFileInput" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                            <div id="uploadPlaceholder">
                                <div class="w-12 h-12 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-3 group-hover:bg-cyan-100 transition-colors">
                                    <span class="text-2xl">ğŸ“·</span>
                                </div>
                                <p class="font-bold text-slate-600 text-sm">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
                                <p class="text-xs text-slate-400 mt-1">JPG / PNG / GIF / WebPï¼ˆæœ€å¤§5MBï¼‰</p>
                            </div>
                            <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­è¡¨ç¤º -->
                            <div id="uploadProgress" class="hidden">
                                <div class="w-12 h-12 mx-auto mb-3 flex items-center justify-center">
                                    <svg class="animate-spin w-8 h-8 text-cyan-500" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                                    </svg>
                                </div>
                                <p class="font-bold text-cyan-600 text-sm">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</p>
                            </div>
                        </div>

                        <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                        <div id="uploadMsg" class="hidden text-xs font-bold px-3 py-2 rounded-xl mt-2 slide-down"></div>

                        <!-- URLç›´æ¥å…¥åŠ› or è‡ªå‹•ç”Ÿæˆ -->
                        <div class="flex gap-2 mt-3">
                            <input id="imageUrlInput" type="url" placeholder="ç”»åƒURLã‚’ç›´æ¥å…¥åŠ›"
                                class="flex-1 px-3 py-2.5 border-2 border-slate-200 rounded-xl outline-none focus:border-cyan-400 bg-slate-50 text-xs"
                                oninput="previewAvatar(this.value)">
                            <button onclick="randomAvatar()"
                                class="px-3 py-2.5 bg-gradient-to-r from-violet-500 to-pink-500 text-white rounded-xl font-bold text-xs whitespace-nowrap hover:opacity-90 transition-all shadow shadow-violet-200">
                                ğŸ² è‡ªå‹•ç”Ÿæˆ
                            </button>
                        </div>
                        <p class="text-xs text-slate-400 mt-1.5 px-1">ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¾ãŸã¯URLã‚’å…¥åŠ›ã€‚ã€Œè‡ªå‹•ç”Ÿæˆã€ã§DiceBearã‚¢ãƒã‚¿ãƒ¼ã‚’ä½œæˆ</p>
                    </div>

                    <!-- è¡¨ç¤ºå -->
                    <div>
                        <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-2">è¡¨ç¤ºå <span class="text-red-400">*</span></label>
                        <input id="mpName" type="text" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ"
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl outline-none focus:border-cyan-400 bg-slate-50">
                    </div>

                    <!-- ç¨¼åƒçŠ¶æ³ -->
                    <div>
                        <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-3">ç¨¼åƒçŠ¶æ³</label>
                        <div class="grid grid-cols-3 gap-2">
                            <label class="availability-card cursor-pointer">
                                <input type="radio" name="availability" value="å—ä»˜ä¸­" class="hidden">
                                <div class="border-2 border-emerald-200 bg-emerald-50 rounded-xl p-3 text-center transition-all hover:border-emerald-400">
                                    <div class="text-lg mb-1">ğŸŸ¢</div>
                                    <div class="text-xs font-black text-emerald-700">å—ä»˜ä¸­</div>
                                </div>
                            </label>
                            <label class="availability-card cursor-pointer">
                                <input type="radio" name="availability" value="æ··é›‘ä¸­" class="hidden">
                                <div class="border-2 border-amber-200 bg-amber-50 rounded-xl p-3 text-center transition-all hover:border-amber-400">
                                    <div class="text-lg mb-1">ğŸŸ¡</div>
                                    <div class="text-xs font-black text-amber-700">æ··é›‘ä¸­</div>
                                </div>
                            </label>
                            <label class="availability-card cursor-pointer">
                                <input type="radio" name="availability" value="å—ä»˜åœæ­¢" class="hidden">
                                <div class="border-2 border-red-200 bg-red-50 rounded-xl p-3 text-center transition-all hover:border-red-400">
                                    <div class="text-lg mb-1">ğŸ”´</div>
                                    <div class="text-xs font-black text-red-700">å—ä»˜åœæ­¢</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- å˜ä¾¡ -->
                    <div>
                        <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-2">å˜ä¾¡ç›®å®‰</label>
                        <input id="mpPrice" type="text" placeholder="ä¾‹ï¼šÂ¥3,000ã€œ"
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl outline-none focus:border-cyan-400 bg-slate-50">
                    </div>

                    <!-- ä½¿ç”¨å¯èƒ½ã‚½ãƒ•ãƒˆ -->
                    <div>
                        <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-3">ä½¿ç”¨å¯èƒ½ã‚½ãƒ•ãƒˆ</label>
                        <div class="flex flex-wrap gap-2" id="toolsChips">
                            <span class="tool-chip"><input type="checkbox" id="sw1" value="Premiere Pro"><label for="sw1">ğŸ¬ Premiere Pro</label></span>
                            <span class="tool-chip"><input type="checkbox" id="sw2" value="After Effects"><label for="sw2">âœ¨ After Effects</label></span>
                            <span class="tool-chip"><input type="checkbox" id="sw3" value="Final Cut Pro"><label for="sw3">ğŸ¥ Final Cut Pro</label></span>
                            <span class="tool-chip"><input type="checkbox" id="sw4" value="DaVinci Resolve"><label for="sw4">ğŸï¸ DaVinci Resolve</label></span>
                            <span class="tool-chip"><input type="checkbox" id="sw5" value="Photoshop"><label for="sw5">ğŸ¨ Photoshop</label></span>
                            <span class="tool-chip"><input type="checkbox" id="sw6" value="Cinema 4D"><label for="sw6">ğŸ­ Cinema 4D</label></span>
                            <span class="tool-chip"><input type="checkbox" id="sw7" value="CapCut"><label for="sw7">ğŸ“± CapCut</label></span>
                        </div>
                    </div>

                    <!-- å¾—æ„ã‚¸ãƒ£ãƒ³ãƒ« -->
                    <div>
                        <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-3">å¾—æ„ã‚¸ãƒ£ãƒ³ãƒ«</label>
                        <div class="flex flex-wrap gap-2" id="genreChips">
                            <span class="genre-chip"><input type="checkbox" id="g1" value="Shortsã‚²ãƒ¼ãƒ å®Ÿæ³"><label for="g1">ğŸ® ã‚²ãƒ¼ãƒ å®Ÿæ³</label></span>
                            <span class="genre-chip"><input type="checkbox" id="g2" value="VTuber"><label for="g2">ğŸŒŸ VTuber</label></span>
                            <span class="genre-chip"><input type="checkbox" id="g3" value="æ–™ç†ãƒ»ã‚°ãƒ«ãƒ¡"><label for="g3">ğŸœ æ–™ç†ãƒ»ã‚°ãƒ«ãƒ¡</label></span>
                            <span class="genre-chip"><input type="checkbox" id="g4" value="æ—…è¡Œãƒ»Vlog"><label for="g4">âœˆï¸ æ—…è¡Œãƒ»Vlog</label></span>
                            <span class="genre-chip"><input type="checkbox" id="g5" value="æ•™è‚²ãƒ»ãƒã‚¦ãƒ„ãƒ¼"><label for="g5">ğŸ“š æ•™è‚²ãƒ»ãƒã‚¦ãƒ„ãƒ¼</label></span>
                            <span class="genre-chip"><input type="checkbox" id="g6" value="éŸ³æ¥½ãƒ»ãƒ€ãƒ³ã‚¹"><label for="g6">ğŸµ éŸ³æ¥½ãƒ»ãƒ€ãƒ³ã‚¹</label></span>
                            <span class="genre-chip"><input type="checkbox" id="g7" value="ã‚¹ãƒãƒ¼ãƒ„"><label for="g7">âš½ ã‚¹ãƒãƒ¼ãƒ„</label></span>
                            <span class="genre-chip"><input type="checkbox" id="g8" value="åˆ‡ã‚ŠæŠœã"><label for="g8">âœ‚ï¸ åˆ‡ã‚ŠæŠœã</label></span>
                        </div>
                    </div>

                    <!-- SNSã‚¢ã‚«ã‚¦ãƒ³ãƒˆ -->
                    <div>
                        <label class="block text-xs font-black text-slate-400 uppercase tracking-wider mb-3">SNSã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</label>
                        <div class="space-y-2.5">
                            <div class="flex items-center gap-3">
                                <span class="w-8 text-center text-lg flex-shrink-0">â–¶ï¸</span>
                                <input id="snYoutube" type="url" placeholder="YouTube ãƒãƒ£ãƒ³ãƒãƒ«URL"
                                    class="flex-1 px-4 py-2.5 border-2 border-slate-200 rounded-xl outline-none focus:border-red-400 bg-slate-50 text-sm">
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="w-8 text-center text-lg flex-shrink-0">ğŸµ</span>
                                <input id="snTiktok" type="url" placeholder="TikTok ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«URL"
                                    class="flex-1 px-4 py-2.5 border-2 border-slate-200 rounded-xl outline-none focus:border-slate-400 bg-slate-50 text-sm">
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="w-8 text-center text-lg flex-shrink-0">ğŸ“¸</span>
                                <input id="snInstagram" type="url" placeholder="Instagram ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«URL"
                                    class="flex-1 px-4 py-2.5 border-2 border-slate-200 rounded-xl outline-none focus:border-pink-400 bg-slate-50 text-sm">
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="w-8 text-center text-lg flex-shrink-0">ğŸ¦</span>
                                <input id="snX" type="url" placeholder="X (Twitter) ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«URL"
                                    class="flex-1 px-4 py-2.5 border-2 border-slate-200 rounded-xl outline-none focus:border-slate-600 bg-slate-50 text-sm">
                            </div>
                        </div>
                    </div>

                    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                    <div id="mypageStatus" class="hidden text-sm font-bold px-4 py-3 rounded-xl text-center slide-down"></div>

                    <button onclick="handleUpdate()"
                        class="w-full gradient-btn text-white py-4 rounded-2xl font-black text-base shadow-lg shadow-cyan-200 hover:scale-[1.02] hover:opacity-90 transition-all">
                        ğŸ’¾ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã™ã‚‹
                    </button>
                </div>

                <!-- ===== ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª ===== -->
                <div id="sectionPortfolio" class="hidden space-y-5">

                    <!-- å‹•ç”»URLè¿½åŠ  -->
                    <div class="card p-7">
                        <h3 class="font-black text-slate-700 mb-1">ğŸ¬ å‹•ç”»ã‚’è¿½åŠ </h3>
                        <p class="text-xs text-slate-400 mb-4">YouTubeãƒ»YouTube Shortsãƒ»TikTokã®URLã«å¯¾å¿œã—ã¦ã„ã¾ã™</p>

                        <!-- å¯¾å¿œãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒãƒƒã‚¸ -->
                        <div class="flex gap-2 mb-4">
                            <span class="flex items-center gap-1.5 text-xs font-bold px-3 py-1.5 rounded-full bg-red-50 text-red-500 border border-red-100">
                                <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M23.5 6.19a3.02 3.02 0 00-2.12-2.14C19.54 3.5 12 3.5 12 3.5s-7.54 0-9.38.55A3.02 3.02 0 00.5 6.19C0 8.04 0 12 0 12s0 3.96.5 5.81a3.02 3.02 0 002.12 2.14C4.46 20.5 12 20.5 12 20.5s7.54 0 9.38-.55a3.02 3.02 0 002.12-2.14C24 15.96 24 12 24 12s0-3.96-.5-5.81zM9.75 15.02V8.98L15.5 12l-5.75 3.02z"/></svg>
                                YouTube
                            </span>
                            <span class="flex items-center gap-1.5 text-xs font-bold px-3 py-1.5 rounded-full bg-red-50 text-red-500 border border-red-100">
                                <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M23.5 6.19a3.02 3.02 0 00-2.12-2.14C19.54 3.5 12 3.5 12 3.5s-7.54 0-9.38.55A3.02 3.02 0 00.5 6.19C0 8.04 0 12 0 12s0 3.96.5 5.81a3.02 3.02 0 002.12 2.14C4.46 20.5 12 20.5 12 20.5s7.54 0 9.38-.55a3.02 3.02 0 002.12-2.14C24 15.96 24 12 24 12s0-3.96-.5-5.81zM9.75 15.02V8.98L15.5 12l-5.75 3.02z"/></svg>
                                YouTube Shorts
                            </span>
                            <span class="flex items-center gap-1.5 text-xs font-bold px-3 py-1.5 rounded-full bg-slate-800 text-white border border-slate-700">
                                <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1V9.01a6.33 6.33 0 00-.79-.05 6.34 6.34 0 00-6.34 6.34 6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.33-6.34V8.69a8.18 8.18 0 004.78 1.52V6.75a4.85 4.85 0 01-1.01-.06z"/></svg>
                                TikTok
                            </span>
                        </div>

                        <div class="flex gap-3">
                            <input id="ytUrlInput" type="url" placeholder="å‹•ç”»ã®URLã‚’è²¼ã‚Šä»˜ã‘..."
                                class="flex-1 px-4 py-3 border-2 border-slate-200 rounded-xl outline-none focus:border-cyan-400 bg-slate-50 text-sm">
                            <button onclick="addVideo()"
                                class="px-5 py-3 gradient-btn text-white rounded-xl font-bold text-sm hover:opacity-90 transition-all shadow-lg shadow-cyan-200 whitespace-nowrap">
                                è¿½åŠ 
                            </button>
                        </div>
                        <div id="addVideoMsg" class="hidden text-xs font-bold px-3 py-2 rounded-xl mt-2"></div>
                    </div>

                    <!-- ã‚µãƒ ãƒã‚¤ãƒ«ã‚®ãƒ£ãƒ©ãƒªãƒ¼ -->
                    <div class="card p-7">
                        <div class="flex items-center justify-between mb-5">
                            <h3 class="font-black text-slate-700">ğŸ“¸ ä½œå“ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h3>
                            <span class="text-xs text-slate-400 font-bold" id="videoCount">0 / 6</span>
                        </div>
                        <div id="thumbGallery" class="thumb-grid">
                            <div class="col-span-3 text-center py-12 text-slate-300">
                                <div class="text-4xl mb-2">ğŸ¬</div>
                                <p class="text-sm font-bold">å‹•ç”»URLã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                            </div>
                        </div>
                        <button onclick="saveVideos()"
                            id="saveVideoBtn"
                            class="hidden w-full mt-5 gradient-btn text-white py-3.5 rounded-2xl font-black text-sm shadow-lg shadow-cyan-200 hover:scale-[1.02] transition-all">
                            ğŸ’¾ ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’ä¿å­˜ã™ã‚‹
                        </button>
                        <div id="videoStatus" class="hidden text-sm font-bold px-4 py-3 rounded-xl text-center slide-down mt-3"></div>
                    </div>

                </div>

                <!-- ===== ãƒãƒ£ãƒƒãƒˆ ===== -->
                <div id="sectionChat" class="hidden">
                    <div class="card overflow-hidden flex flex-col" style="min-height: 600px;">

                        <!-- ãƒãƒ£ãƒƒãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ -->
                        <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3 bg-white flex-shrink-0">
                            <div class="w-9 h-9 gradient-btn rounded-xl flex items-center justify-center text-white text-base flex-shrink-0">ğŸ’¬</div>
                            <div class="flex-1 min-w-0">
                                <div class="font-black text-slate-800 text-sm" id="chatHeaderTitle">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
                                <div class="text-xs text-slate-400" id="chatOnlineStatus">æ¥ç¶šä¸­...</div>
                            </div>
                            <span id="chatRoleBadge" class="text-xs font-bold px-3 py-1 rounded-full bg-cyan-100 text-cyan-700 flex-shrink-0"></span>
                        </div>

                        <!-- æœ¬ä½“ï¼šã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‹ä¼šè©±ã‚¨ãƒªã‚¢ -->
                        <div class="flex flex-1 overflow-hidden" style="min-height: 520px;">

                            <!-- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä¸€è¦§ï¼‰ï¼ç·¨é›†è€…ã®ã¿è¡¨ç¤º -->
                            <div id="chatSidebar" class="hidden w-52 flex-shrink-0 border-r border-slate-100 flex flex-col bg-slate-50">
                                <div class="px-3 py-3 border-b border-slate-100">
                                    <p class="text-xs font-black text-slate-400 uppercase tracking-wider">ä¾é ¼è€…ä¸€è¦§</p>
                                </div>
                                <div class="flex-1 overflow-y-auto" id="clientList">
                                    <div class="text-center py-8 text-slate-300 text-xs">
                                        <div class="text-2xl mb-1">ğŸ“­</div>
                                        <p>ã¾ã ä¾é ¼ãŒã‚ã‚Šã¾ã›ã‚“</p>
                                    </div>
                                </div>
                            </div>

                            <!-- å³ï¼šä¼šè©±ã‚¨ãƒªã‚¢ -->
                            <div class="flex-1 flex flex-col overflow-hidden">
                                <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ -->
                                <div class="chat-messages flex-1" id="chatMessages">
                                    <div class="text-center py-16 text-slate-300">
                                        <div class="text-4xl mb-3">ğŸ’¬</div>
                                        <p class="text-sm font-bold" id="chatEmptyMsg">èª­ã¿è¾¼ã¿ä¸­...</p>
                                    </div>
                                </div>

                                <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                                <div class="chat-input-area flex-shrink-0" id="chatInputArea">
                                    <textarea id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." rows="1"
                                        onkeydown="if(event.key==='Enter' && !event.shiftKey){ event.preventDefault(); sendMessage(); }"
                                        oninput="this.style.height='auto'; this.style.height=Math.min(this.scrollHeight,120)+'px'"></textarea>
                                    <button class="chat-send-btn" onclick="sendMessage()">â¤</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div><!-- /#mypageSection -->

    <!-- ===== ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ãƒã‚¤ãƒšãƒ¼ã‚¸ ===== -->
    <div id="clientSection" class="hidden fade-in">
        <div class="mypage-layout">

            <!-- å·¦ã‚«ãƒ©ãƒ  -->
            <div class="space-y-5">
                <div class="card p-6 text-center">
                    <div class="relative inline-block mb-4">
                        <img id="clientAvatarImg" src="https://api.dicebear.com/7.x/avataaars/svg?seed=client" alt="avatar"
                            class="w-24 h-24 rounded-2xl avatar-ring object-cover mx-auto cursor-pointer"
                            onclick="document.getElementById('clientAvatarFile').click()" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦å¤‰æ›´">
                        <div class="absolute -bottom-1 -right-1 w-7 h-7 gradient-btn rounded-full flex items-center justify-center text-white text-xs shadow cursor-pointer"
                            onclick="document.getElementById('clientAvatarFile').click()">âœï¸</div>
                        <input type="file" id="clientAvatarFile" accept="image/*" class="hidden" onchange="uploadClientAvatar(event)">
                    </div>
                    <div id="clientAvatarMsg" class="hidden text-xs font-bold px-3 py-1.5 rounded-xl mb-2"></div>
                    <h2 class="text-xl font-black text-slate-800 mt-1" id="clientName">èª­ã¿è¾¼ã¿ä¸­...</h2>
                    <p class="text-cyan-500 font-bold text-sm mt-1" id="clientEmail"></p>
                    <span class="inline-block mt-2 px-3 py-1 bg-cyan-100 text-cyan-700 text-xs font-black rounded-full">ğŸ¬ ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼</span>
                    <button onclick="handleLogout()"
                        class="mt-4 w-full text-slate-400 text-sm py-2.5 rounded-xl border-2 border-slate-100 hover:text-red-500 hover:border-red-100 transition-all font-bold">
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </button>
                </div>
                <!-- çµ±è¨ˆ -->
                <div class="card p-5">
                    <h3 class="font-black text-slate-700 text-sm mb-4">ğŸ“Š åˆ©ç”¨çŠ¶æ³</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-slate-500 font-bold">ç›¸è«‡ä¸­ã®ç·¨é›†è€…</span>
                            <span class="text-lg font-black gradient-text" id="clientStatThreads">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-slate-500 font-bold">ãŠæ°—ã«å…¥ã‚Šç™»éŒ²</span>
                            <span class="text-lg font-black text-pink-500" id="clientStatFavs">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ã‚«ãƒ©ãƒ  -->
            <div class="space-y-5">
                <div class="card p-2 flex gap-1 flex-wrap">
                    <button class="section-tab active" onclick="switchClientSection('threads', this)">ğŸ’¬ ç›¸è«‡ä¸­ã®ç·¨é›†è€…</button>
                    <button class="section-tab" onclick="switchClientSection('favorites', this)">â¤ï¸ ãŠæ°—ã«å…¥ã‚Š</button>
                    <button class="section-tab" onclick="switchClientSection('clientChat', this)">ğŸ“¨ ãƒãƒ£ãƒƒãƒˆ</button>
                </div>

                <!-- ç›¸è«‡ä¸­ã‚¹ãƒ¬ãƒƒãƒ‰ -->
                <div id="clientSectionThreads" class="card p-6">
                    <h3 class="font-black text-slate-700 mb-4 flex items-center gap-2">
                        ğŸ’¬ ç›¸è«‡ä¸­ã®ç·¨é›†è€…
                        <span class="text-xs font-bold text-slate-400">ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ãŸç·¨é›†è€…ï¼‰</span>
                    </h3>
                    <div id="threadList">
                        <div class="text-center py-10 text-slate-300">
                            <div class="text-4xl mb-2">ğŸ“­</div>
                            <p class="text-sm font-bold">ã¾ã ç›¸è«‡ã—ãŸç·¨é›†è€…ãŒã„ã¾ã›ã‚“</p>
                            <a href="index.html" class="inline-block mt-3 text-xs font-bold text-cyan-500 hover:underline">ç·¨é›†è€…ã‚’æ¢ã™ â†’</a>
                        </div>
                    </div>
                </div>

                <!-- ãŠæ°—ã«å…¥ã‚Š -->
                <div id="clientSectionFavorites" class="hidden card p-6">
                    <h3 class="font-black text-slate-700 mb-4 flex items-center gap-2">
                        â¤ï¸ ãŠæ°—ã«å…¥ã‚Šã®ç·¨é›†è€…
                        <span class="text-xs font-bold text-slate-400">ï¼ˆãƒãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ä¿å­˜ï¼‰</span>
                    </h3>
                    <div id="favoriteList">
                        <div class="text-center py-10 text-slate-300">
                            <div class="text-4xl mb-2">ğŸ’”</div>
                            <p class="text-sm font-bold">ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ãŸç·¨é›†è€…ãŒã„ã¾ã›ã‚“</p>
                            <a href="index.html" class="inline-block mt-3 text-xs font-bold text-cyan-500 hover:underline">ç·¨é›†è€…ã‚’æ¢ã™ â†’</a>
                        </div>
                    </div>
                </div>

                <!-- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ãƒãƒ£ãƒƒãƒˆ -->
                <div id="clientSectionClientChat" class="hidden">
                    <div class="card overflow-hidden flex flex-col" style="min-height:560px;">
                        <div class="px-5 py-4 border-b border-slate-100 flex items-center gap-3 bg-white flex-shrink-0">
                            <div class="w-9 h-9 gradient-btn rounded-xl flex items-center justify-center text-white flex-shrink-0">ğŸ’¬</div>
                            <div class="flex-1 min-w-0">
                                <div class="font-black text-slate-800 text-sm" id="clientChatTitle">ç·¨é›†è€…ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
                                <div class="text-xs text-slate-400">ç›¸è«‡ä¸­ã®ç·¨é›†è€…ã¨ãƒãƒ£ãƒƒãƒˆ</div>
                            </div>
                            <span class="text-xs font-bold px-3 py-1 rounded-full bg-cyan-100 text-cyan-700 flex-shrink-0">ğŸ¬ ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼</span>
                        </div>
                        <div class="flex flex-1 overflow-hidden" style="min-height:440px;">
                            <div class="w-48 flex-shrink-0 border-r border-slate-100 flex flex-col bg-slate-50">
                                <div class="px-3 py-3 border-b border-slate-100">
                                    <p class="text-xs font-black text-slate-400 uppercase">ç·¨é›†è€…ä¸€è¦§</p>
                                </div>
                                <div class="flex-1 overflow-y-auto" id="clientEditorSidebar">
                                    <div class="text-center py-6 text-slate-300 text-xs"><div class="text-2xl mb-1">ğŸ“­</div><p>ç›¸è«‡ä¸­ã®ç·¨é›†è€…ãªã—</p></div>
                                </div>
                            </div>
                            <div class="flex-1 flex flex-col overflow-hidden">
                                <div class="chat-messages flex-1" id="clientChatMessages">
                                    <div class="text-center py-12 text-slate-300">
                                        <div class="text-4xl mb-3">ğŸ’¬</div>
                                        <p class="text-sm font-bold">ç·¨é›†è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                                    </div>
                                </div>
                                <div class="chat-input-area flex-shrink-0">
                                    <textarea id="clientChatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." rows="1"
                                        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendClientMessage();}"
                                        oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px'"></textarea>
                                    <button class="chat-send-btn" onclick="sendClientMessage()">â¤</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div><!-- /#clientSection -->

</main>

<script>
    // ===== Supabase =====
    const SUPABASE_URL = 'https://dwmgwdhunvanrsautvtj.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_GzaEGCWBP7y0za2UVPiJNA_N3pdlgJ0';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let videoList = []; // å‹•ç”»URLä¸€è¦§

    // ===== èµ·å‹• =====
    window.addEventListener('load', async () => {
        const { data: { session } } = await sb.auth.getSession();
        if (session) {
            await loadMypage(session.user);
            // request.htmlã‹ã‚‰é·ç§»ã—ã¦ããŸå ´åˆã€ãƒãƒ£ãƒƒãƒˆã‚¿ãƒ–ã‚’è‡ªå‹•ã§é–‹ã
            const openChat = new URLSearchParams(location.search).get('open_chat');
            if (openChat) {
                setTimeout(() => {
                    const chatBtn = document.querySelector('.section-tab:nth-child(3)');
                    if (chatBtn) {
                        switchSection('chat', chatBtn);
                        // initChatå®Œäº†å¾Œã«ç›¸æ‰‹ã‚’é¸æŠ
                        setTimeout(() => selectChatPartner(openChat), 1200);
                    }
                }, 600);
            }
        } else {
            showAuth();
        }
    });

    // ===== ã‚¿ãƒ– =====
    function switchTab(tab) {
        const isLogin = tab === 'login';
        document.getElementById('loginForm').classList.toggle('hidden', !isLogin);
        document.getElementById('registerForm').classList.toggle('hidden', isLogin);
        document.getElementById('tabLogin').className  = `flex-1 py-2.5 rounded-xl font-bold text-sm transition-all ${isLogin  ? 'tab-active' : 'tab-inactive'}`;
        document.getElementById('tabRegister').className = `flex-1 py-2.5 rounded-xl font-bold text-sm transition-all ${!isLogin ? 'tab-active' : 'tab-inactive'}`;
    }

    // ãƒ­ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ã®è¦‹ãŸç›®åˆ‡ã‚Šæ›¿ãˆ
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('input[name="regRole"]').forEach(radio => {
            radio.addEventListener('change', () => {
                document.querySelectorAll('.role-card > div').forEach(d => {
                    d.style.borderColor = '#e2e8f0';
                    d.style.background  = '#f8fafc';
                    d.style.boxShadow   = 'none';
                });
                const checked = document.querySelector('input[name="regRole"]:checked');
                if (checked) {
                    const card = checked.nextElementSibling;
                    card.style.borderColor = '#06b6d4';
                    card.style.background  = '#ecfeff';
                    card.style.boxShadow   = '0 0 0 3px rgba(6,182,212,0.2)';
                }
            });
        });
    });

    // ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ãƒ– =====
    function switchSection(section, btn) {
        document.querySelectorAll('.section-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('sectionProfile').classList.toggle('hidden', section !== 'profile');
        document.getElementById('sectionPortfolio').classList.toggle('hidden', section !== 'portfolio');
        document.getElementById('sectionChat').classList.toggle('hidden', section !== 'chat');
        if (section === 'chat') initChat();
    }

    // ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ =====
    function showMsg(elId, msg, type) {
        const el = document.getElementById(elId);
        const s = { error:'bg-red-50 text-red-600 border border-red-200', success:'bg-emerald-50 text-emerald-600 border border-emerald-200', info:'bg-cyan-50 text-cyan-600 border border-cyan-200' };
        el.className = `text-sm font-bold px-4 py-3 rounded-xl slide-down ${s[type]||s.info}`;
        el.textContent = msg;
        el.classList.remove('hidden');
    }
    function hideMsg(id) { document.getElementById(id).classList.add('hidden'); }

    // ===== ãƒ­ã‚°ã‚¤ãƒ³ =====
    async function handleLogin() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        hideMsg('loginMsg');
        if (!email || !password) { showMsg('loginMsg','âš ï¸ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error'); return; }
        showMsg('loginMsg','â³ ãƒ­ã‚°ã‚¤ãƒ³ä¸­...','info');
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) { showMsg('loginMsg', translateAuthError(error.message), 'error'); return; }
        showMsg('loginMsg','âœ… ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¾ã™','success');
        setTimeout(() => loadMypage(data.user), 1000);
    }

    // ===== æ–°è¦ç™»éŒ² =====
    async function handleRegister() {
        const name            = document.getElementById('regName').value.trim();
        const email           = document.getElementById('regEmail').value.trim();
        const password        = document.getElementById('regPassword').value;
        const passwordConfirm = document.getElementById('regPasswordConfirm').value;
        const role            = document.querySelector('input[name="regRole"]:checked')?.value || 'client';
        hideMsg('registerMsg');

        if (!name)               { showMsg('registerMsg','âš ï¸ ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error'); return; }
        if (!email)              { showMsg('registerMsg','âš ï¸ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error'); return; }
        if (password.length < 6) { showMsg('registerMsg','âš ï¸ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„','error'); return; }
        if (password !== passwordConfirm) { showMsg('registerMsg','âš ï¸ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¦ã„ã¾ã›ã‚“','error'); return; }

        showMsg('registerMsg','â³ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆä¸­...','info');

        const { data, error } = await sb.auth.signUp({ email, password });
        if (error) {
            showMsg('registerMsg', translateAuthError(error.message), 'error');
            return;
        }
        if (data.user) {
            await sb.from('users').upsert({ id: data.user.id, name, role }, { onConflict: 'id' });
            if (role === 'editor') {
                await sb.from('editors').upsert({ id: data.user.id, name }, { onConflict: 'id' });
            }
            showMsg('registerMsg','âœ… ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼','success');
            setTimeout(() => loadMypage(data.user), 1500);
        } else {
            showMsg('registerMsg','ğŸ“© ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚','info');
        }
    }

    // ===== Supabaseã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ—¥æœ¬èªåŒ– =====
    function translateAuthError(msg) {
        if (msg.includes('email rate limit exceeded') || msg.includes('rate limit')) {
            return 'âš ï¸ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚\n\nã“ã‚Œã¯Supabaseã®ç„¡æ–™ãƒ—ãƒ©ãƒ³ã®åˆ¶é™ï¼ˆ1æ™‚é–“ã«æ•°ä»¶ã¾ã§ï¼‰ã§ã™ã€‚\nå°‘ã—æ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        }
        if (msg.includes('User already registered') || msg.includes('already been registered')) {
            return 'âš ï¸ ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚';
        }
        if (msg.includes('Password should be at least')) {
            return 'âš ï¸ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„ã€‚';
        }
        if (msg.includes('Invalid email')) {
            return 'âš ï¸ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
        }
        if (msg.includes('signup disabled') || msg.includes('Signups not allowed')) {
            return 'âš ï¸ ç¾åœ¨æ–°è¦ç™»éŒ²ãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚';
        }
        if (msg.includes('Email not confirmed')) {
            return 'âš ï¸ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèªãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚å±Šã„ãŸç¢ºèªãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚';
        }
        // ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼
        if (msg.includes('Invalid login credentials')) {
            return 'âŒ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚';
        }
        if (msg.includes('Email link is invalid') || msg.includes('Token has expired')) {
            return 'âš ï¸ ãƒªãƒ³ã‚¯ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        }
        return 'âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + msg;
    }

    // ===== ãƒã‚¤ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ï¼ˆãƒ­ãƒ¼ãƒ«åˆ¤å®šï¼‰ =====
    async function loadMypage(user) {
        document.getElementById('headerEmail').textContent = user.email;

        // usersãƒ†ãƒ¼ãƒ–ãƒ«ã§roleç¢ºèª
        const { data: uData } = await sb.from('users').select('role, name').eq('id', user.id).maybeSingle();

        // usersãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã„å ´åˆ â†’ editorsãƒ†ãƒ¼ãƒ–ãƒ«ã§åˆ¤å®šï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼äº’æ›ï¼‰
        if (!uData) {
            const { data: eData } = await sb.from('editors').select('id').filter('id::text','eq',user.id).maybeSingle();
            if (eData) {
                // æ—¢å­˜ç·¨é›†è€… â†’ usersãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»è¡Œç™»éŒ²ã—ã¦ã‹ã‚‰ç·¨é›†è€…ãƒšãƒ¼ã‚¸
                await sb.from('users').upsert({ id: user.id, role: 'editor' }, { onConflict: 'id' });
                await loadEditorPage(user);
            } else {
                // æœªç™»éŒ² â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã—ã¦æ‰±ã†
                await sb.from('users').upsert({ id: user.id, role: 'client' }, { onConflict: 'id' });
                await loadClientPage(user);
            }
            return;
        }

        if (uData.role === 'editor') {
            await loadEditorPage(user);
        } else {
            await loadClientPage(user);
        }
    }

    // ===== ç·¨é›†è€…ãƒã‚¤ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ï¼ˆæ—§loadMypageã®å†…å®¹ï¼‰ =====
    async function loadEditorPage(user) {
        showMypage();
        document.getElementById('mypageEmail').textContent = user.email;
        document.getElementById('headerEmail').textContent = user.email;

        const { data } = await sb.from('editors').select('*').filter('id::text','eq',user.id).maybeSingle();
        if (!data) { renderMypage({ name: 'æœªè¨­å®š' }, user); return; }

        // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
        document.getElementById('mpName').value        = data.name          || '';
        document.getElementById('mpPrice').value       = data.price         || '';
        document.getElementById('imageUrlInput').value = data.image_url     || '';

        // ç¨¼åƒçŠ¶æ³
        const avail = data.availability || 'å—ä»˜ä¸­';
        const availRadio = document.querySelector(`input[name="availability"][value="${avail}"]`);
        if (availRadio) availRadio.checked = true;

        // SNSãƒªãƒ³ã‚¯
        const sns = data.sns_links || {};
        document.getElementById('snYoutube').value   = sns.youtube   || '';
        document.getElementById('snTiktok').value    = sns.tiktok    || '';
        document.getElementById('snInstagram').value = sns.instagram || '';
        document.getElementById('snX').value         = sns.x         || '';

        // å®Ÿç¸¾ãƒ»è©•ä¾¡
        document.getElementById('statsProjects').textContent = data.projects != null ? data.projects + 'ä»¶' : '-';
        document.getElementById('statsRating').textContent   = data.rating   != null ? data.rating           : '-';

        // ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
        const tools = Array.isArray(data.tools) ? data.tools : [];
        document.querySelectorAll('#toolsChips input[type=checkbox]').forEach(cb => {
            cb.checked = tools.includes(cb.value);
        });

        // ã‚¸ãƒ£ãƒ³ãƒ«ãƒã‚§ãƒƒã‚¯
        const genres = Array.isArray(data.genres) ? data.genres : [];
        document.querySelectorAll('#genreChips input[type=checkbox]').forEach(cb => {
            cb.checked = genres.includes(cb.value);
        });

        // å‹•ç”»ãƒªã‚¹ãƒˆ
        videoList = Array.isArray(data.sample_videos) ? data.sample_videos : [];
        renderGallery();

        renderMypage(data, user);
    }

    // ===== UIåæ˜  =====
    function renderMypage(data, user) {
        const name   = data.name  || 'æœªè¨­å®š';
        const price  = data.price || '';
        const tools  = Array.isArray(data.tools)  ? data.tools  : [];
        const genres = Array.isArray(data.genres) ? data.genres : [];

        // ã‚¢ãƒã‚¿ãƒ¼
        const avatarUrl = data.image_url
            || `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(name)}`;
        document.getElementById('avatarImg').src    = avatarUrl;
        document.getElementById('previewAvatar').src = avatarUrl;

        // åå‰ãƒ»ãƒ¡ãƒ¼ãƒ«
        document.getElementById('mypageName').textContent = name;
        document.getElementById('previewName').textContent = name;

        // å˜ä¾¡
        document.getElementById('profilePrice').textContent = price ? price : '';
        document.getElementById('previewPrice').textContent = price || 'æœªè¨­å®š';

        // ã‚¸ãƒ£ãƒ³ãƒ«
        document.getElementById('previewGenres').textContent =
            genres.length > 0 ? genres.slice(0,2).join(' / ') : 'å¾—æ„ã‚¸ãƒ£ãƒ³ãƒ«æœªè¨­å®š';

        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒã‚¸ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ï¼‰
        const badgeColors = {
            'Premiere Pro':'bg-violet-100 text-violet-700',
            'After Effects':'bg-blue-100 text-blue-700',
            'Final Cut Pro':'bg-indigo-100 text-indigo-700',
            'DaVinci Resolve':'bg-red-100 text-red-700',
            'Photoshop':'bg-sky-100 text-sky-700',
            'Cinema 4D':'bg-pink-100 text-pink-700',
            'CapCut':'bg-emerald-100 text-emerald-700',
        };
        document.getElementById('profileToolBadges').innerHTML = tools.map(t =>
            `<span class="text-xs font-bold px-2.5 py-1 rounded-full ${badgeColors[t]||'bg-slate-100 text-slate-600'}">${t}</span>`
        ).join('');

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒã‚¸
        const toolIcons = {'Premiere Pro':'ğŸ¬','After Effects':'âœ¨','Final Cut Pro':'ğŸ¥','DaVinci Resolve':'ğŸï¸','Photoshop':'ğŸ¨','Cinema 4D':'ğŸ­','CapCut':'ğŸ“±'};
        document.getElementById('previewTools').innerHTML = tools.slice(0,4).map(t =>
            `<span class="text-xs font-bold px-2 py-0.5 rounded-lg bg-slate-100 text-slate-600">${toolIcons[t]||'ğŸ’»'} ${t}</span>`
        ).join('');
    }

    // ===== ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ =====
    function handleDrop(e) {
        e.preventDefault();
        document.getElementById('uploadArea').classList.remove('border-cyan-400','bg-cyan-50/30');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) uploadAvatarFile(file);
        else alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
    }

    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) uploadAvatarFile(file);
    }

    async function uploadAvatarFile(file) {
        // 5MBä¸Šé™ãƒã‚§ãƒƒã‚¯
        if (file.size > 5 * 1024 * 1024) {
            showUploadMsg('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„', 'error');
            return;
        }

        // â‘  ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å³æ™‚åæ˜ 
        const localUrl = URL.createObjectURL(file);
        document.getElementById('avatarImg').src     = localUrl;
        document.getElementById('previewAvatar').src = localUrl;

        // â‘¡ ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        document.getElementById('uploadPlaceholder').classList.add('hidden');
        document.getElementById('uploadProgress').classList.remove('hidden');
        hideMsg('uploadMsg');

        try {
            const { data: { user } } = await sb.auth.getUser();
            if (!user) throw new Error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„');

            // â‘¢ ãƒ•ã‚¡ã‚¤ãƒ«åï¼šuserId.æ‹¡å¼µå­ï¼ˆæ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãï¼‰
            const ext      = file.name.split('.').pop();
            const filePath = `${user.id}.${ext}`;

            const { error: upErr } = await sb.storage
                .from('avatars')
                .upload(filePath, file, { upsert: true, contentType: file.type });

            if (upErr) throw upErr;

            // â‘£ å…¬é–‹URLå–å¾—
            const { data: urlData } = sb.storage.from('avatars').getPublicUrl(filePath);
            const publicUrl = urlData.publicUrl;

            // â‘¤ editorsãƒ†ãƒ¼ãƒ–ãƒ«ã®image_urlã‚’è‡ªå‹•æ›´æ–°
            const { error: dbErr } = await sb.from('editors').upsert(
                { id: user.id, image_url: publicUrl },
                { onConflict: 'id' }
            );
            if (dbErr) throw dbErr;

            // â‘¥ URLå…¥åŠ›æ¬„ã«ã‚‚åæ˜ 
            document.getElementById('imageUrlInput').value = publicUrl;
            document.getElementById('avatarImg').src        = publicUrl;
            document.getElementById('previewAvatar').src    = publicUrl;

            showUploadMsg('âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');

        } catch (err) {
            console.error('upload error:', err);
            showUploadMsg('âŒ ' + err.message, 'error');
        } finally {
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('uploadProgress').classList.add('hidden');
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã§ãã‚‹ã‚ˆã†ã«ï¼‰
            document.getElementById('avatarFileInput').value = '';
        }
    }

    function showUploadMsg(msg, type) {
        const el = document.getElementById('uploadMsg');
        const s  = { error:'bg-red-50 text-red-600 border border-red-200', success:'bg-emerald-50 text-emerald-600 border border-emerald-200' };
        el.className = `text-xs font-bold px-3 py-2 rounded-xl mt-2 slide-down ${s[type]||'bg-cyan-50 text-cyan-600'}`;
        el.textContent = msg;
        el.classList.remove('hidden');
        if (type === 'success') setTimeout(() => el.classList.add('hidden'), 4000);
    }

    // ===== ã‚¢ãƒã‚¿ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ =====
    function previewAvatar(url) {
        const src = url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${Math.random()}`;
        document.getElementById('avatarImg').src     = src;
        document.getElementById('previewAvatar').src = src;
    }

    function randomAvatar() {
        const styles = ['avataaars','bottts','fun-emoji','lorelei','micah','personas'];
        const style  = styles[Math.floor(Math.random() * styles.length)];
        const seed   = Math.random().toString(36).slice(2);
        const url    = `https://api.dicebear.com/7.x/${style}/svg?seed=${seed}`;
        document.getElementById('imageUrlInput').value = url;
        previewAvatar(url);
    }

    // ===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ =====
    async function handleUpdate() {
        hideMsg('mypageStatus');
        const name  = document.getElementById('mpName').value.trim();
        if (!name) { showMsg('mypageStatus','âš ï¸ è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error'); return; }
        showMsg('mypageStatus','â³ ä¿å­˜ä¸­...','info');

        const { data: { user } } = await sb.auth.getUser();
        if (!user) { showMsg('mypageStatus','âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™','error'); return; }

        const tools  = Array.from(document.querySelectorAll('#toolsChips input:checked')).map(c=>c.value);
        const genres = Array.from(document.querySelectorAll('#genreChips input:checked')).map(c=>c.value);
        const avail  = document.querySelector('input[name="availability"]:checked')?.value || 'å—ä»˜ä¸­';
        const sns = {
            youtube:   document.getElementById('snYoutube').value.trim()   || null,
            tiktok:    document.getElementById('snTiktok').value.trim()    || null,
            instagram: document.getElementById('snInstagram').value.trim() || null,
            x:         document.getElementById('snX').value.trim()         || null,
        };

        const { error } = await sb.from('editors').upsert({
            id:           user.id,
            name,
            price:        document.getElementById('mpPrice').value.trim()       || null,
            image_url:    document.getElementById('imageUrlInput').value.trim() || null,
            sns_links:    sns,
            tools,
            genres,
            availability: avail,
        }, { onConflict: 'id' });

        if (error) { console.error(error); showMsg('mypageStatus','âŒ '+error.message,'error'); return; }

        const currentData = {
            name, price: document.getElementById('mpPrice').value.trim(),
            image_url: document.getElementById('imageUrlInput').value.trim(),
            tools, genres, availability: avail,
        };
        renderMypage(currentData, user);
        showMsg('mypageStatus','âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼','success');
        setTimeout(() => hideMsg('mypageStatus'), 3000);
    }

    // ===== YouTubeã‚µãƒ ãƒã‚¤ãƒ« =====
    // ===== å‹•ç”»URLè§£æï¼ˆYouTubeé€šå¸¸ãƒ»Shortsãƒ»TikTokå¯¾å¿œï¼‰=====
    function parseVideoUrl(url) {
        // YouTubeé€šå¸¸: watch?v=XXXX or youtu.be/XXXX
        const ytNormal = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
        if (ytNormal) return { type: 'youtube', id: ytNormal[1] };

        // YouTube Shorts: /shorts/XXXX
        const ytShorts = url.match(/youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/);
        if (ytShorts) return { type: 'youtube_shorts', id: ytShorts[1] };

        // TikTok: /@user/video/XXXX or /v/XXXX
        const tiktok = url.match(/tiktok\.com\/@[\w.-]+\/video\/(\d+)/);
        if (tiktok) return { type: 'tiktok', id: tiktok[1], url };

        // TikTokçŸ­ç¸®URL: vm.tiktok.com / vt.tiktok.com
        const tiktokShort = url.match(/(?:vm|vt)\.tiktok\.com\/([a-zA-Z0-9]+)/);
        if (tiktokShort) return { type: 'tiktok', id: tiktokShort[1], url };

        return null;
    }

    function addVideo() {
        const addMsg = document.getElementById('addVideoMsg');
        addMsg.classList.add('hidden');

        if (videoList.length >= 6) {
            addMsg.className = 'text-xs font-bold px-3 py-2 rounded-xl mt-2 bg-red-50 text-red-500 border border-red-100';
            addMsg.textContent = 'âš ï¸ å‹•ç”»ã¯æœ€å¤§6ä»¶ã¾ã§è¿½åŠ ã§ãã¾ã™';
            addMsg.classList.remove('hidden');
            return;
        }

        const url    = document.getElementById('ytUrlInput').value.trim();
        const parsed = parseVideoUrl(url);

        if (!parsed) {
            addMsg.className = 'text-xs font-bold px-3 py-2 rounded-xl mt-2 bg-red-50 text-red-500 border border-red-100';
            addMsg.textContent = 'âŒ å¯¾å¿œã—ã¦ã„ãªã„URLã§ã™ã€‚YouTubeãƒ»YouTube Shortsãƒ»TikTokã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
            addMsg.classList.remove('hidden');
            return;
        }

        const key = parsed.type + '_' + parsed.id;
        if (videoList.find(v => (v.type + '_' + v.id) === key)) {
            addMsg.className = 'text-xs font-bold px-3 py-2 rounded-xl mt-2 bg-amber-50 text-amber-600 border border-amber-100';
            addMsg.textContent = 'âš ï¸ ã“ã®å‹•ç”»ã¯ã™ã§ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™';
            addMsg.classList.remove('hidden');
            return;
        }

        videoList.push({ type: parsed.type, id: parsed.id, url });
        document.getElementById('ytUrlInput').value = '';
        renderGallery();
    }

    function removeVideo(index) {
        videoList.splice(index, 1);
        renderGallery();
    }

    function renderGallery() {
        const gallery  = document.getElementById('thumbGallery');
        const countEl  = document.getElementById('videoCount');
        const saveBtn  = document.getElementById('saveVideoBtn');
        countEl.textContent = `${videoList.length} / 6`;
        saveBtn.classList.toggle('hidden', videoList.length === 0);

        if (videoList.length === 0) {
            gallery.innerHTML = `
                <div class="col-span-3 text-center py-12 text-slate-300">
                    <div class="text-4xl mb-2">ğŸ¬</div>
                    <p class="text-sm font-bold">å‹•ç”»URLã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                </div>`;
            return;
        }

        gallery.innerHTML = videoList.map((v, i) => {
            const isYt     = v.type === 'youtube' || v.type === 'youtube_shorts' || !v.type;
            const isTikTok = v.type === 'tiktok';
            const badge    = v.type === 'youtube_shorts' ? 'Shorts' : isTikTok ? 'TikTok' : 'YouTube';
            const badgeBg  = isTikTok ? '#010101' : '#ff0000';

            let thumbSrc, linkUrl, hoverEmbed;

            if (isYt) {
                thumbSrc   = `https://img.youtube.com/vi/${v.id}/mqdefault.jpg`;
                linkUrl    = v.type === 'youtube_shorts' ? `https://youtube.com/shorts/${v.id}` : `https://youtube.com/watch?v=${v.id}`;
                hoverEmbed = `<iframe class="thumb-video"
                    src="https://www.youtube.com/embed/${v.id}?autoplay=1&mute=1&controls=0&loop=1&playlist=${v.id}&rel=0"
                    frameborder="0" allow="autoplay; encrypted-media" allowfullscreen
                    style="position:absolute;inset:0;width:100%;height:100%;opacity:0;transition:opacity 0.3s;pointer-events:none;border-radius:10px;"></iframe>`;
            } else if (isTikTok) {
                // TikTok: ã‚µãƒ ãƒã‚¤ãƒ«ã¯é»’èƒŒæ™¯ã®ã‚¢ã‚¤ã‚³ãƒ³ã€ãƒ›ãƒãƒ¼ã§åŸ‹ã‚è¾¼ã¿iframeã‚’è¡¨ç¤º
                thumbSrc   = '';  // TikTokã‚µãƒ ãƒã‚¤ãƒ«ã¯å…¬å¼APIãªã—
                linkUrl    = v.url || '#';
                // TikTok oEmbed embed URLï¼ˆvideo IDãŒæ•°å­—ã®å ´åˆï¼‰
                const ttEmbedUrl = `https://www.tiktok.com/embed/v2/${v.id}?autoplay=1&muted=1`;
                hoverEmbed = `<iframe class="thumb-video"
                    src="${ttEmbedUrl}"
                    frameborder="0" allow="autoplay; encrypted-media"
                    style="position:absolute;inset:0;width:100%;height:100%;opacity:0;transition:opacity 0.3s;pointer-events:none;border-radius:10px;"></iframe>`;
            }

            // TikTokã®ã‚µãƒ ãƒã‚¤ãƒ«èƒŒæ™¯ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰
            const thumbHtml = isTikTok
                ? `<div class="thumb-static" style="position:absolute;inset:0;background:#010101;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="white"><path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-2.88 2.5 2.89 2.89 0 01-2.89-2.89 2.89 2.89 0 012.89-2.89c.28 0 .54.04.79.1V9.01a6.33 6.33 0 00-.79-.05 6.34 6.34 0 00-6.34 6.34 6.34 6.34 0 006.34 6.34 6.34 6.34 0 006.33-6.34V8.69a8.18 8.18 0 004.78 1.52V6.75a4.85 4.85 0 01-1.01-.06z"/></svg>
                    <span style="color:white;font-size:10px;font-weight:700;">TikTok</span>
                   </div>`
                : `<img class="thumb-static" src="${thumbSrc}" alt="${badge}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transition:opacity 0.2s;">`;

            return `
            <div class="thumb-item group relative"
                style="position:relative;"
                onmouseenter="activateVideoPreview(this)"
                onmouseleave="deactivateVideoPreview(this)">
                <a href="${linkUrl}" target="_blank" rel="noopener" style="display:block;width:100%;height:100%;position:relative;">
                    ${thumbHtml}
                    ${hoverEmbed}
                    <div class="thumb-play" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.3);opacity:0;transition:opacity 0.2s;">
                        <span style="width:40px;height:40px;background:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 4px 12px rgba(0,0,0,0.3);">â–¶</span>
                    </div>
                </a>
                <span style="position:absolute;bottom:6px;left:6px;background:${badgeBg};color:white;font-size:10px;font-weight:700;padding:2px 7px;border-radius:6px;z-index:10;">${badge}</span>
                <button onclick="removeVideo(${i})"
                    style="position:absolute;top:6px;right:6px;width:22px;height:22px;background:#ef4444;color:white;border:none;border-radius:50%;font-size:11px;font-weight:900;cursor:pointer;opacity:0;transition:opacity 0.2s;z-index:10;display:flex;align-items:center;justify-content:center;"
                    class="group-hover:opacity-100">âœ•</button>
            </div>`;
        }).join('');
    }

    // ===== ãƒ›ãƒãƒ¼å‹•ç”»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ =====
    function activateVideoPreview(el) {
        const iframe = el.querySelector('iframe.thumb-video');
        const static_ = el.querySelector('.thumb-static');
        const playBtn  = el.querySelector('.thumb-play');
        const delBtn   = el.querySelector('button');
        if (iframe) iframe.style.opacity = '1';
        if (static_) static_.style.opacity = '0';
        if (playBtn) playBtn.style.opacity = '0';
        if (delBtn)  delBtn.style.opacity  = '1';
    }

    function deactivateVideoPreview(el) {
        const iframe  = el.querySelector('iframe.thumb-video');
        const static_ = el.querySelector('.thumb-static');
        const playBtn  = el.querySelector('.thumb-play');
        const delBtn   = el.querySelector('button');
        if (iframe) {
            iframe.style.opacity = '0';
            // iframeã‚’å†ç”Ÿæˆã—ã¦å‹•ç”»ã‚’åœæ­¢
            const newSrc = iframe.src;
            setTimeout(() => { if (iframe.parentNode) iframe.src = newSrc; }, 300);
        }
        if (static_) static_.style.opacity = '1';
        if (playBtn) playBtn.style.opacity = '0';
        if (delBtn)  delBtn.style.opacity  = '0';
    }

    async function saveVideos() {
        hideMsg('videoStatus');
        showMsg('videoStatus','â³ ä¿å­˜ä¸­...','info');
        const { data: { user } } = await sb.auth.getUser();
        if (!user) { showMsg('videoStatus','âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™','error'); return; }
        const { error } = await sb.from('editors').upsert({
            id: user.id,
            sample_videos: videoList,
        }, { onConflict: 'id' });
        if (error) { showMsg('videoStatus','âŒ '+error.message,'error'); return; }
        showMsg('videoStatus','âœ… ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼','success');
        setTimeout(() => hideMsg('videoStatus'), 3000);
    }

    // ===== ãƒãƒ£ãƒƒãƒˆï¼ˆå½¹å‰²åˆ†é›¢ç‰ˆï¼‰=====
    let currentUserId    = null;
    let currentUserName  = null;
    let chatPartnerId    = null;
    let chatPartnerName  = null;   // ç›¸æ‰‹ã®è¡¨ç¤ºå
    let isEditor         = false;
    let chatSubscription = null;

    async function initChat() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) return;
        currentUserId = user.id;

        document.getElementById('chatOnlineStatus').textContent = 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³';

        // è‡ªåˆ†ãŒeditorsãƒ†ãƒ¼ãƒ–ãƒ«ã«å­˜åœ¨ã™ã‚‹ã‹ â†’ ç·¨é›†è€…åˆ¤å®š
        const { data: me } = await sb.from('editors').select('id, name').filter('id::text', 'eq', user.id).maybeSingle();
        currentUserName = me?.name || 'ã‚ãªãŸ';
        isEditor = !!me;

        if (isEditor) {
            // ===== ç·¨é›†è€…ãƒ¢ãƒ¼ãƒ‰ï¼šè‡ªåˆ†ã«å±Šã„ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä¸€è¦§ã‚’è¡¨ç¤º =====
            document.getElementById('chatRoleBadge').textContent  = 'âœï¸ ç·¨é›†è€…';
            document.getElementById('chatRoleBadge').className    = 'text-xs font-bold px-3 py-1 rounded-full bg-blue-100 text-blue-700 flex-shrink-0';
            document.getElementById('chatHeaderTitle').textContent = 'å—ä¿¡ã—ãŸä¾é ¼';
            document.getElementById('chatSidebar').classList.remove('hidden');
            document.getElementById('chatSidebar').classList.add('flex');
            document.getElementById('chatEmptyMsg').textContent    = 'å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰ä¾é ¼è€…ã‚’é¸æŠã—ã¦ãã ã•ã„';

            await loadClientList();
        } else {
            // ===== ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šè‡ªåˆ†ãŒé€ã£ãŸç·¨é›†è€…ä¸€è¦§ï¼ˆæ—¢å­˜ãƒãƒ£ãƒƒãƒˆï¼‰ =====
            document.getElementById('chatRoleBadge').textContent  = 'ğŸ¬ ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼';
            document.getElementById('chatRoleBadge').className    = 'text-xs font-bold px-3 py-1 rounded-full bg-cyan-100 text-cyan-700 flex-shrink-0';
            document.getElementById('chatHeaderTitle').textContent = 'ç·¨é›†è€…ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸';
            document.getElementById('chatEmptyMsg').textContent    = 'ä¾é ¼ãƒšãƒ¼ã‚¸ã‹ã‚‰ç·¨é›†è€…ã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Œã¾ã™';

            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯è‡ªåˆ†ãŒé€ã£ãŸç›¸æ‰‹ï¼ˆç·¨é›†è€…ï¼‰ã¨ã®ä¼šè©±ã‚’è¡¨ç¤º
            await loadSentEditorList();
        }
    }

    // ===== ç·¨é›†è€…ï¼šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€ =====
    async function loadClientList() {
        const { data: msgs } = await sb.from('messages')
            .select('sender_id, created_at, content')
            .eq('receiver_id', currentUserId)
            .order('created_at', { ascending: false });

        const listEl = document.getElementById('clientList');
        if (!msgs || msgs.length === 0) {
            listEl.innerHTML = `<div class="text-center py-8 text-slate-300 text-xs"><div class="text-2xl mb-1">ğŸ“­</div><p>ã¾ã ä¾é ¼ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
            return;
        }

        const seen = new Map();
        msgs.forEach(m => { if (!seen.has(m.sender_id)) seen.set(m.sender_id, m); });
        const uniqueSenders = Array.from(seen.values());
        const senderIds = uniqueSenders.map(m => m.sender_id);

        // usersãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰åå‰ãƒ»ã‚¢ãƒã‚¿ãƒ¼ã‚’å–å¾—ï¼ˆã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã¯editorsã«ã„ãªã„ï¼‰
        const { data: usersData } = await sb.from('users').select('id, name, avatar_url').in('id', senderIds);
        const nameMap = {};
        (usersData || []).forEach(u => { nameMap[u.id] = { name: u.name, avatar: u.avatar_url }; });

        listEl.innerHTML = '';
        uniqueSenders.forEach(m => {
            const info    = nameMap[m.sender_id] || {};
            const name    = info.name || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
            const avatar  = info.avatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${m.sender_id}`;
            const preview = (m.content || '').replace(/\n/g,' ').slice(0, 28) + ((m.content || '').length > 28 ? 'â€¦' : '');
            const item = document.createElement('button');
            item.className = 'w-full flex items-center gap-2.5 px-3 py-3 hover:bg-cyan-50 transition-colors text-left border-b border-slate-100';
            item.dataset.clientId = m.sender_id;
            item.innerHTML = `
                <img src="${avatar}" class="w-8 h-8 rounded-full object-cover flex-shrink-0" alt="">
                <div class="min-w-0 flex-1">
                    <div class="text-xs font-black text-slate-700 truncate">${name}</div>
                    <div class="text-[11px] text-slate-400 truncate">${preview}</div>
                </div>`;
            item.onclick = () => selectChatPartner(m.sender_id, item);
            listEl.appendChild(item);
        });
    }

    // ===== ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼šè‡ªåˆ†ãŒé€ã£ãŸç·¨é›†è€…ã‚’å–å¾— =====
    async function loadSentEditorList() {
        const { data: msgs } = await sb.from('messages')
            .select('receiver_id')
            .eq('sender_id', currentUserId)
            .order('created_at', { ascending: false });

        if (!msgs || msgs.length === 0) {
            document.getElementById('chatEmptyMsg').textContent = 'ä¾é ¼ãƒšãƒ¼ã‚¸ã‹ã‚‰ç·¨é›†è€…ã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Œã¾ã™';
            return;
        }

        // ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–
        const seen = new Set();
        const ids  = [];
        msgs.forEach(m => { if (!seen.has(m.receiver_id)) { seen.add(m.receiver_id); ids.push(m.receiver_id); } });

        if (ids.length === 1) {
            // 1ä»¶ã®ã¿ãªã‚‰è‡ªå‹•é¸æŠ
            await selectChatPartner(ids[0]);
        } else {
            // è¤‡æ•°ã®å ´åˆã¯ã‚µã‚¤ãƒ‰ãƒãƒ¼ä»£ã‚ã‚Šã«ç°¡æ˜“ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            document.getElementById('chatEmptyMsg').textContent = `${ids.length}ä»¶ã®ç·¨é›†è€…ã¨ã‚„ã‚Šå–ã‚Šä¸­`;
            // æœ€åˆã®ç›¸æ‰‹ã‚’è‡ªå‹•é¸æŠ
            await selectChatPartner(ids[0]);
        }
    }

    async function selectChatPartner(partnerId, activeBtn = null) {
        chatPartnerId = partnerId;

        document.querySelectorAll('#clientList button').forEach(b => b.classList.remove('bg-cyan-100'));
        if (activeBtn) activeBtn.classList.add('bg-cyan-100');

        if (chatSubscription) { chatSubscription.unsubscribe(); chatSubscription = null; }

        // ç›¸æ‰‹åã‚’usersãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å–å¾—ï¼ˆã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ã¯editorsã«ã„ãªã„ï¼‰
        const { data: uPartner } = await sb.from('users').select('name').eq('id', partnerId).maybeSingle();
        const { data: ePartner } = await sb.from('editors').select('name').filter('id::text','eq',partnerId).maybeSingle();
        chatPartnerName = uPartner?.name || ePartner?.name || 'ç›¸æ‰‹';
        document.getElementById('chatHeaderTitle').textContent = chatPartnerName + ' ã¨ã®ä¼šè©±';

        await loadMessages();

        chatSubscription = sb.channel('room-' + [currentUserId, partnerId].sort().join('-'))
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                const msg = payload.new;
                const sid = msg.sender_id.toString();
                const rid = msg.receiver_id.toString();
                const me  = currentUserId.toString();
                const pt  = chatPartnerId.toString();
                if ((sid === me && rid === pt) || (sid === pt && rid === me)) {
                    appendMessage(msg, sid === me);
                }
            })
            .subscribe();
    }

    async function loadMessages() {
        const { data: msgs } = await sb.from('messages')
            .select('*')
            .or(`and(sender_id.eq.${currentUserId},receiver_id.eq.${chatPartnerId}),and(sender_id.eq.${chatPartnerId},receiver_id.eq.${currentUserId})`)
            .order('created_at', { ascending: true });

        const container = document.getElementById('chatMessages');
        container.innerHTML = '';

        if (!msgs || msgs.length === 0) {
            container.innerHTML = `
                <div class="text-center py-10 text-slate-300">
                    <div class="text-3xl mb-2">âœ‰ï¸</div>
                    <p class="text-sm font-bold">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    <p class="text-xs mt-1">æœ€åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
                </div>`;
            return;
        }

        let lastDate = '';
        msgs.forEach(msg => {
            const isMe   = msg.sender_id.toString() === currentUserId.toString();
            const msgDate = new Date(msg.created_at).toLocaleDateString('ja-JP', { month: 'long', day: 'numeric' });
            if (msgDate !== lastDate) {
                const div = document.createElement('div');
                div.className = 'chat-date-divider';
                div.textContent = msgDate;
                container.appendChild(div);
                lastDate = msgDate;
            }
            appendMessage(msg, isMe, false);
        });
        scrollChatBottom();
    }

    // ===== ã‚¢ãƒã‚¿ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆID â†’ URLï¼‰ =====
    const avatarCache = {};

    async function resolveAvatar(userId) {
        if (avatarCache[userId]) return avatarCache[userId];
        // usersãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ãƒ»ç·¨é›†è€…å…±é€šï¼‰
        const { data: u } = await sb.from('users').select('avatar_url').eq('id', userId).maybeSingle();
        if (u?.avatar_url) { avatarCache[userId] = u.avatar_url; return u.avatar_url; }
        // editorsãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆimage_urlï¼‰
        const { data: e } = await sb.from('editors').select('image_url').filter('id::text','eq',userId).maybeSingle();
        if (e?.image_url) { avatarCache[userId] = e.image_url; return e.image_url; }
        const fallback = `https://api.dicebear.com/7.x/avataaars/svg?seed=${userId}`;
        avatarCache[userId] = fallback;
        return fallback;
    }

    function appendMessage(msg, isMe, doScroll = true) {
        const container = document.getElementById('chatMessages');
        const empty = container.querySelector('.text-center');
        if (empty) empty.remove();

        const time = new Date(msg.created_at).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        const senderId = isMe ? currentUserId : msg.sender_id;

        // ã‚¢ãƒã‚¿ãƒ¼ã‚’éåŒæœŸã§å–å¾—ã—ã¦ã‹ã‚‰DOMæŒ¿å…¥
        const wrap = document.createElement('div');
        wrap.className = 'chat-bubble-wrap';
        wrap.innerHTML = `
            <div class="chat-row ${isMe ? 'me' : ''}">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${senderId}" class="chat-avatar-sm" data-uid="${senderId}" alt="">
                <div class="chat-msg-group">
                    <div class="chat-bubble ${isMe ? 'me' : 'them'}">${escapeHtml(msg.content)}</div>
                    <div class="chat-time">${time}</div>
                </div>
            </div>`;
        container.appendChild(wrap);

        // éåŒæœŸã§ã‚¢ãƒã‚¿ãƒ¼ã‚’æ­£ã—ã„ç”»åƒã«å·®ã—æ›¿ãˆ
        resolveAvatar(senderId).then(url => {
            const img = wrap.querySelector(`img[data-uid="${senderId}"]`);
            if (img) img.src = url;
        });

        if (doScroll) scrollChatBottom();
    }

    function appendClientMessage(msg, isMe, doScroll = true) {
        const container = document.getElementById('clientChatMessages');
        const empty = container.querySelector('.text-center');
        if (empty) empty.remove();

        const time = new Date(msg.created_at).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
        const senderId = isMe ? clientUserId : msg.sender_id;

        const wrap = document.createElement('div');
        wrap.className = 'chat-bubble-wrap';
        wrap.innerHTML = `
            <div class="chat-row ${isMe ? 'me' : ''}">
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${senderId}" class="chat-avatar-sm" data-uid="${senderId}" alt="">
                <div class="chat-msg-group">
                    <div class="chat-bubble ${isMe ? 'me' : 'them'}">${escapeHtml(msg.content)}</div>
                    <div class="chat-time">${time}</div>
                </div>
            </div>`;
        container.appendChild(wrap);

        resolveAvatar(senderId).then(url => {
            const img = wrap.querySelector(`img[data-uid="${senderId}"]`);
            if (img) img.src = url;
        });

        if (doScroll) container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
        const input   = document.getElementById('chatInput');
        const content = input.value.trim();
        if (!content || !chatPartnerId) return;
        input.value = '';
        input.style.height = 'auto';

        const { error } = await sb.from('messages').insert({
            sender_id:   currentUserId,
            receiver_id: chatPartnerId,
            content,
        });
        if (error) { console.error('send error:', error); alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message); }
    }

    // ===== ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ ã‚¢ãƒã‚¿ãƒ¼ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ =====
    async function uploadClientAvatar(event) {
        const file = event.target.files[0];
        if (!file) return;
        const msgEl = document.getElementById('clientAvatarMsg');
        const showAvatarMsg = (txt, type) => {
            const s = { error:'bg-red-50 text-red-500', success:'bg-emerald-50 text-emerald-600', info:'bg-cyan-50 text-cyan-600' };
            msgEl.className = `text-xs font-bold px-3 py-1.5 rounded-xl mb-2 ${s[type]}`;
            msgEl.textContent = txt;
            msgEl.classList.remove('hidden');
            if (type !== 'error') setTimeout(() => msgEl.classList.add('hidden'), 3000);
        };

        if (file.size > 2 * 1024 * 1024) { showAvatarMsg('âš ï¸ 2MBä»¥ä¸‹ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„', 'error'); return; }
        showAvatarMsg('â³ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...', 'info');

        const { data: { user } } = await sb.auth.getUser();
        const ext      = file.name.split('.').pop();
        const filePath = `avatars/${user.id}.${ext}`;

        const { error: upErr } = await sb.storage.from('avatars').upload(filePath, file, { upsert: true });
        if (upErr) { showAvatarMsg('âŒ ' + upErr.message, 'error'); return; }

        const { data: urlData } = sb.storage.from('avatars').getPublicUrl(filePath);
        const publicUrl = urlData.publicUrl + '?t=' + Date.now();

        // usersãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
        await sb.from('users').update({ avatar_url: publicUrl }).eq('id', user.id);

        document.getElementById('clientAvatarImg').src = publicUrl;
        showAvatarMsg('âœ… ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
    }

    function scrollChatBottom() {
        const el = document.getElementById('chatMessages');
        if (el) el.scrollTop = el.scrollHeight;
    }

    function escapeHtml(str) {
        return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
    }

    // ===== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =====
    async function handleLogout() {
        await sb.auth.signOut();
        showAuth();
    }

    // ===== UIåˆ‡ã‚Šæ›¿ãˆ =====
    function showAuth() {
        document.getElementById('authSection').classList.remove('hidden');
        document.getElementById('mypageSection').classList.add('hidden');
        document.getElementById('clientSection').classList.add('hidden');
    }
    function showMypage() {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('mypageSection').classList.remove('hidden');
        document.getElementById('clientSection').classList.add('hidden');
    }
    function showClient() {
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('mypageSection').classList.add('hidden');
        document.getElementById('clientSection').classList.remove('hidden');
    }

    // ===== ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ =====
    function switchClientSection(section, btn) {
        document.querySelectorAll('#clientSection .section-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('clientSectionThreads').classList.toggle('hidden',     section !== 'threads');
        document.getElementById('clientSectionFavorites').classList.toggle('hidden',   section !== 'favorites');
        document.getElementById('clientSectionClientChat').classList.toggle('hidden',  section !== 'clientChat');
        if (section === 'clientChat') initClientChat();
    }

    // ===== ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ ãƒã‚¤ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ =====
    async function loadClientPage(user) {
        showClient();
        document.getElementById('clientEmail').textContent = user.email;
        document.getElementById('headerEmail').textContent = user.email;

        // usersãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰åå‰å–å¾—
        const { data: uData } = await sb.from('users').select('name, avatar_url').eq('id', user.id).maybeSingle();
        const name   = uData?.name   || user.email.split('@')[0];
        const avatar = uData?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(name)}`;
        document.getElementById('clientName').textContent  = name;
        document.getElementById('clientAvatarImg').src     = avatar;

        // ç›¸è«‡ä¸­ã®ç·¨é›†è€…ï¼ˆè‡ªåˆ†ãŒsender_idã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®receiver_idã‚’é›†è¨ˆï¼‰
        const { data: sentMsgs } = await sb.from('messages')
            .select('receiver_id').eq('sender_id', user.id);
        const uniqueEditorIds = [...new Set((sentMsgs||[]).map(m => m.receiver_id))];
        document.getElementById('clientStatThreads').textContent = uniqueEditorIds.length + 'äºº';

        // ãŠæ°—ã«å…¥ã‚Šï¼ˆfavorites ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ï¼‰
        const { data: favs } = await sb.from('favorites')
            .select('editor_id').eq('client_id', user.id);
        document.getElementById('clientStatFavs').textContent = (favs||[]).length + 'äºº';

        // ã‚¹ãƒ¬ãƒƒãƒ‰ã‚«ãƒ¼ãƒ‰æç”»
        await renderThreadList(user.id, uniqueEditorIds);

        // ãŠæ°—ã«å…¥ã‚Šã‚«ãƒ¼ãƒ‰æç”»
        await renderFavoriteList(user.id, (favs||[]).map(f => f.editor_id));

        // open_chat ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œ
        const openChat = new URLSearchParams(location.search).get('open_chat');
        if (openChat) {
            const chatBtn = document.querySelector('#clientSection .section-tab:nth-child(3)');
            if (chatBtn) {
                setTimeout(() => {
                    switchClientSection('clientChat', chatBtn);
                    setTimeout(() => selectClientEditor(openChat), 800);
                }, 400);
            }
        }
    }

    // ===== ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§æç”» =====
    async function renderThreadList(userId, editorIds) {
        const listEl = document.getElementById('threadList');
        if (editorIds.length === 0) return;

        // ç·¨é›†è€…æƒ…å ±ã‚’å–å¾—
        const { data: editors } = await sb.from('editors').select('id, name, image_url, price')
            .in('id', editorIds);
        if (!editors || editors.length === 0) return;

        // å„ç·¨é›†è€…ã®æœ€æ–°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        const { data: allMsgs } = await sb.from('messages')
            .select('receiver_id, content, created_at')
            .eq('sender_id', userId)
            .order('created_at', { ascending: false });

        const latestMap = {};
        (allMsgs || []).forEach(m => {
            if (!latestMap[m.receiver_id]) latestMap[m.receiver_id] = m;
        });

        listEl.innerHTML = editors.map(e => {
            const latest  = latestMap[e.id];
            const preview = latest ? latest.content.split('\n').filter(l => l.trim()).slice(-1)[0] || '' : '';
            const timeStr = latest ? new Date(latest.created_at).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }) : '';
            const avatar  = e.image_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(e.name)}`;
            return `
            <div class="thread-card flex items-center gap-3 mb-3" onclick="openThreadChat('${e.id}', '${(e.name||'').replace(/'/g,'')}')" >
                <img src="${avatar}" class="w-12 h-12 rounded-2xl object-cover flex-shrink-0" alt="">
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-center mb-0.5">
                        <span class="font-black text-slate-800 text-sm truncate">${e.name}</span>
                        <span class="text-xs text-slate-400 flex-shrink-0 ml-2">${timeStr}</span>
                    </div>
                    <div class="text-xs text-slate-500 truncate">${preview.slice(0, 60)}</div>
                    ${e.price ? `<span class="text-xs text-cyan-600 font-bold">${e.price}</span>` : ''}
                </div>
                <div class="w-8 h-8 gradient-btn rounded-xl flex items-center justify-center text-white text-xs flex-shrink-0">ğŸ’¬</div>
            </div>`;
        }).join('');
    }

    // ===== ãŠæ°—ã«å…¥ã‚Šæç”» =====
    async function renderFavoriteList(userId, editorIds) {
        const listEl = document.getElementById('favoriteList');
        if (editorIds.length === 0) return;

        const { data: editors } = await sb.from('editors').select('id, name, image_url, price, tools')
            .in('id', editorIds);
        if (!editors || editors.length === 0) return;

        listEl.innerHTML = `<div class="grid grid-cols-1 gap-3">` + editors.map(e => {
            const avatar = e.image_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(e.name)}`;
            const tools  = Array.isArray(e.tools) ? e.tools.slice(0, 3).join(' Â· ') : '';
            return `
            <div class="fav-editor-card flex items-center gap-4">
                <img src="${avatar}" class="w-14 h-14 rounded-2xl object-cover flex-shrink-0" alt="">
                <div class="flex-1 min-w-0">
                    <div class="font-black text-slate-800">${e.name}</div>
                    ${tools ? `<div class="text-xs text-slate-400 mt-0.5">${tools}</div>` : ''}
                    ${e.price ? `<div class="text-sm font-black text-cyan-600 mt-1">${e.price}</div>` : ''}
                </div>
                <div class="flex flex-col gap-2">
                    <button onclick="removeFavorite('${e.id}')" class="text-xs text-pink-400 hover:text-pink-600 font-bold border-2 border-pink-200 px-3 py-1.5 rounded-xl hover:border-pink-400 transition-all">â¤ï¸ è§£é™¤</button>
                    <button onclick="goToRequest('${e.id}','${(e.name||'').replace(/'/g,'')}','')" class="text-xs gradient-btn text-white px-3 py-1.5 rounded-xl font-bold">ç›¸è«‡ã™ã‚‹</button>
                </div>
            </div>`;
        }).join('') + `</div>`;
    }

    function goToRequest(editorId, editorName, editorAvatar) {
        const p = new URLSearchParams({ editor_id: editorId, editor_name: editorName, editor_avatar: editorAvatar });
        window.location.href = 'request.html?' + p.toString();
    }

    async function removeFavorite(editorId) {
        const { data: { user } } = await sb.auth.getUser();
        await sb.from('favorites').delete().eq('client_id', user.id).eq('editor_id', editorId);
        await loadClientPage(user);
    }

    function openThreadChat(editorId, editorName) {
        const chatBtn = document.querySelector('#clientSection .section-tab:nth-child(3)');
        if (chatBtn) {
            switchClientSection('clientChat', chatBtn);
            setTimeout(() => selectClientEditor(editorId), 400);
        }
    }

    // ===== ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ãƒãƒ£ãƒƒãƒˆ =====
    let clientChatPartnerId      = null;
    let clientCurrentPartnerName = null;   // ç›¸æ‰‹ï¼ˆç·¨é›†è€…ï¼‰ã®è¡¨ç¤ºå
    let clientChatSub            = null;
    let clientUserId             = null;

    async function initClientChat() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) return;
        clientUserId = user.id;

        // è‡ªåˆ†ãŒsenderã®receiverï¼ˆç·¨é›†è€…ï¼‰ä¸€è¦§
        const { data: msgs } = await sb.from('messages')
            .select('receiver_id').eq('sender_id', user.id);
        const ids = [...new Set((msgs||[]).map(m => m.receiver_id))];
        const sidebar = document.getElementById('clientEditorSidebar');
        if (ids.length === 0) { sidebar.innerHTML = `<div class="text-center py-6 text-slate-300 text-xs"><div class="text-2xl mb-1">ğŸ“­</div><p>ç›¸è«‡ä¸­ã®ç·¨é›†è€…ãªã—</p></div>`; return; }

        const { data: editors } = await sb.from('editors').select('id, name, image_url').in('id', ids);
        sidebar.innerHTML = '';
        (editors||[]).forEach(e => {
            const avatar = e.image_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(e.name)}`;
            const btn = document.createElement('button');
            btn.className = 'w-full flex items-center gap-2.5 px-3 py-3 hover:bg-cyan-50 transition-colors text-left border-b border-slate-100';
            btn.dataset.editorId = e.id;
            btn.innerHTML = `<img src="${avatar}" class="w-8 h-8 rounded-xl object-cover flex-shrink-0"><span class="text-xs font-black text-slate-700 truncate">${e.name}</span>`;
            btn.onclick = () => selectClientEditor(e.id, btn);
            sidebar.appendChild(btn);
        });
    }

    async function selectClientEditor(editorId, activeBtn = null) {
        clientChatPartnerId = editorId;
        document.querySelectorAll('#clientEditorSidebar button').forEach(b => b.classList.remove('bg-cyan-100'));
        if (activeBtn) activeBtn.classList.add('bg-cyan-100');
        else {
            const b = document.querySelector(`#clientEditorSidebar button[data-editor-id="${editorId}"]`);
            if (b) b.classList.add('bg-cyan-100');
        }

        if (clientChatSub) { clientChatSub.unsubscribe(); clientChatSub = null; }

        const { data: e } = await sb.from('editors').select('name').filter('id::text','eq',editorId).maybeSingle();
        clientCurrentPartnerName = e?.name || 'ç·¨é›†è€…';
        document.getElementById('clientChatTitle').textContent = clientCurrentPartnerName + ' ã¨ã®ä¼šè©±';

        await loadClientMessages();

        clientChatSub = sb.channel('client-room-' + [clientUserId, editorId].sort().join('-'))
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                const msg = payload.new;
                const sid = msg.sender_id.toString();
                const rid = msg.receiver_id.toString();
                const me  = clientUserId.toString();
                const pt  = clientChatPartnerId.toString();
                if ((sid===me&&rid===pt)||(sid===pt&&rid===me)) appendClientMessage(msg, sid===me);
            }).subscribe();
    }

    async function loadClientMessages() {
        const { data: msgs } = await sb.from('messages').select('*')
            .or(`and(sender_id.eq.${clientUserId},receiver_id.eq.${clientChatPartnerId}),and(sender_id.eq.${clientChatPartnerId},receiver_id.eq.${clientUserId})`)
            .order('created_at', { ascending: true });

        const container = document.getElementById('clientChatMessages');
        container.innerHTML = '';
        if (!msgs || msgs.length === 0) {
            container.innerHTML = `<div class="text-center py-10 text-slate-300"><div class="text-3xl mb-2">âœ‰ï¸</div><p class="text-sm font-bold">ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</p></div>`;
            return;
        }
        let lastDate = '';
        msgs.forEach(msg => {
            const isMe = msg.sender_id.toString() === clientUserId.toString();
            const d = new Date(msg.created_at).toLocaleDateString('ja-JP',{month:'long',day:'numeric'});
            if (d !== lastDate) {
                const div = document.createElement('div');
                div.className = 'chat-date-divider'; div.textContent = d;
                container.appendChild(div); lastDate = d;
            }
            appendClientMessage(msg, isMe, false);
        });
        container.scrollTop = container.scrollHeight;
    }

    async function sendClientMessage() {
        const input   = document.getElementById('clientChatInput');
        const content = input.value.trim();
        if (!content || !clientChatPartnerId) return;
        input.value = '';
        input.style.height = 'auto';
        const { error } = await sb.from('messages').insert({ sender_id: clientUserId, receiver_id: clientChatPartnerId, content });
        if (error) alert('é€ä¿¡å¤±æ•—: ' + error.message);
    }
</script>
</body>
</html>
