<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shorts Match - ãƒ­ã‚°ã‚¤ãƒ³ / ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); }
        .gradient-text {
            background: linear-gradient(to right, #06b6d4, #3b82f6);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .gradient-btn { background: linear-gradient(to right, #06b6d4, #3b82f6); }
        .tool-checkbox:checked + .tool-label {
            background: linear-gradient(to right, #06b6d4, #3b82f6);
            color: white; border-color: #06b6d4;
        }
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="gradient-bg min-h-screen">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm">
        <div class="max-w-5xl mx-auto px-6 py-4 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2 font-bold text-xl text-cyan-600">
                â–¶ Shorts Match
            </a>
            <div id="headerNav" class="flex items-center gap-3"></div>
        </div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="max-w-md mx-auto px-6 py-12">

        <!-- ===== ãƒ­ã‚°ã‚¤ãƒ³/æ–°è¦ç™»éŒ²ç”»é¢ ===== -->
        <div id="authSection" class="fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 gradient-btn rounded-2xl flex items-center justify-center text-white text-2xl mx-auto mb-4">âœï¸</div>
                <h1 class="text-3xl font-black text-slate-800 mb-2">ç·¨é›†è€…ãƒãƒ¼ã‚¿ãƒ«</h1>
                <p class="text-slate-500">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç®¡ç†ã—ã¾ã—ã‚‡ã†</p>
            </div>

            <div class="bg-white rounded-3xl shadow-xl p-8">

                <!-- ã‚¿ãƒ– -->
                <div class="flex rounded-2xl bg-slate-100 p-1 mb-8">
                    <button id="tabLogin" onclick="switchTab('login')"
                        class="flex-1 py-2.5 rounded-xl font-bold text-sm transition-all bg-white text-slate-800 shadow-sm">
                        ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                    <button id="tabRegister" onclick="switchTab('register')"
                        class="flex-1 py-2.5 rounded-xl font-bold text-sm transition-all text-slate-500">
                        æ–°è¦ç™»éŒ²
                    </button>
                </div>

                <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="loginForm">
                    <div class="mb-5">
                        <label class="block text-sm font-bold text-slate-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input id="loginEmail" type="email" placeholder="example@email.com"
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-cyan-400 focus:outline-none bg-slate-50 focus:bg-white transition-all">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-slate-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                        <input id="loginPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-cyan-400 focus:outline-none bg-slate-50 focus:bg-white transition-all">
                    </div>
                    <div id="loginError" class="text-red-500 text-sm mb-4 hidden"></div>
                    <button onclick="handleLogin()"
                        class="w-full gradient-btn text-white py-4 rounded-2xl font-bold text-lg hover:opacity-90 hover:scale-[1.02] transition-all shadow-lg shadow-cyan-200">
                        ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                </div>

                <!-- æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="registerForm" class="hidden">
                    <div class="mb-5">
                        <label class="block text-sm font-bold text-slate-700 mb-2">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="text-red-400">*</span></label>
                        <input id="regEmail" type="email" placeholder="example@email.com"
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-cyan-400 focus:outline-none bg-slate-50 focus:bg-white transition-all">
                    </div>
                    <div class="mb-5">
                        <label class="block text-sm font-bold text-slate-700 mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ <span class="text-red-400">*</span>ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰</label>
                        <input id="regPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-cyan-400 focus:outline-none bg-slate-50 focus:bg-white transition-all">
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-slate-700 mb-1">
                            ãŠåå‰ï¼ˆè¡¨ç¤ºåï¼‰<span class="text-red-400">*</span>
                        </label>
                        <p class="text-xs text-slate-400 mb-2">ç·¨é›†è€…ä¸€è¦§ã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤ºã•ã‚Œã‚‹åå‰ã§ã™</p>
                        <input id="regName" type="text" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ"
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-cyan-400 focus:outline-none bg-slate-50 focus:bg-white transition-all">
                    </div>
                    <div id="registerError" class="text-red-500 text-sm mb-4 hidden"></div>
                    <button onclick="handleRegister()"
                        class="w-full gradient-btn text-white py-4 rounded-2xl font-bold text-lg hover:opacity-90 hover:scale-[1.02] transition-all shadow-lg shadow-cyan-200">
                        ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ
                    </button>
                    <p class="text-center text-slate-400 text-xs mt-4">
                        ç™»éŒ²å¾Œã€ç¢ºèªãƒ¡ãƒ¼ãƒ«ãŒé€ã‚‰ã‚Œã¾ã™
                    </p>
                </div>
            </div>
        </div>

        <!-- ===== ãƒã‚¤ãƒšãƒ¼ã‚¸ ===== -->
        <div id="mypageSection" class="hidden fade-in">

            <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="text-center mb-8">
                <div id="mypageAvatar" class="w-20 h-20 rounded-2xl mx-auto mb-4 overflow-hidden border-4 border-white shadow-lg">
                    <img id="mypageAvatarImg" src="" alt="" class="w-full h-full object-cover">
                </div>
                <h1 class="text-2xl font-black text-slate-800" id="mypageName">èª­ã¿è¾¼ã¿ä¸­...</h1>
                <p class="text-cyan-500 font-bold text-sm mt-1" id="mypageEmail"></p>
            </div>

            <!-- ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="bg-white rounded-3xl shadow-xl p-8 mb-6">
                <h2 class="text-lg font-bold text-slate-800 mb-6 flex items-center gap-2">
                    <span class="w-8 h-8 gradient-btn rounded-lg flex items-center justify-center text-white text-sm">âœï¸</span>
                    ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
                </h2>

                <div class="mb-5">
                    <label class="block text-sm font-bold text-slate-700 mb-2">ãŠåå‰ <span class="text-red-400">*</span></label>
                    <input id="mpName" type="text" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ"
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-cyan-400 focus:outline-none bg-slate-50 focus:bg-white transition-all">
                </div>

                <div class="mb-5">
                    <label class="block text-sm font-bold text-slate-700 mb-2">ä½¿ç”¨OS <span class="text-red-400">*</span></label>
                    <select id="mpOs"
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-cyan-400 focus:outline-none bg-slate-50 focus:bg-white transition-all">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="Windows">ğŸªŸ Windows</option>
                        <option value="Mac">ğŸ Mac</option>
                    </select>
                </div>

                <div class="mb-5">
                    <label class="block text-sm font-bold text-slate-700 mb-2">ä½¿ç”¨ã‚½ãƒ•ãƒˆ <span class="text-red-400">*</span>ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                    <div class="flex flex-wrap gap-2 mt-1">
                        <input type="checkbox" class="tool-checkbox hidden" id="mp_t1" value="Premiere Pro">
                        <label class="tool-label cursor-pointer px-4 py-2 rounded-xl border-2 border-slate-200 bg-slate-50 font-bold text-sm text-slate-600 transition-all" for="mp_t1">ğŸ¬ Premiere Pro</label>

                        <input type="checkbox" class="tool-checkbox hidden" id="mp_t2" value="After Effects">
                        <label class="tool-label cursor-pointer px-4 py-2 rounded-xl border-2 border-slate-200 bg-slate-50 font-bold text-sm text-slate-600 transition-all" for="mp_t2">âœ¨ After Effects</label>

                        <input type="checkbox" class="tool-checkbox hidden" id="mp_t3" value="Final Cut Pro">
                        <label class="tool-label cursor-pointer px-4 py-2 rounded-xl border-2 border-slate-200 bg-slate-50 font-bold text-sm text-slate-600 transition-all" for="mp_t3">ğŸ¥ Final Cut Pro</label>

                        <input type="checkbox" class="tool-checkbox hidden" id="mp_t4" value="DaVinci Resolve">
                        <label class="tool-label cursor-pointer px-4 py-2 rounded-xl border-2 border-slate-200 bg-slate-50 font-bold text-sm text-slate-600 transition-all" for="mp_t4">ğŸï¸ DaVinci Resolve</label>

                        <input type="checkbox" class="tool-checkbox hidden" id="mp_t5" value="Photoshop">
                        <label class="tool-label cursor-pointer px-4 py-2 rounded-xl border-2 border-slate-200 bg-slate-50 font-bold text-sm text-slate-600 transition-all" for="mp_t5">ğŸ¨ Photoshop</label>

                        <input type="checkbox" class="tool-checkbox hidden" id="mp_t6" value="Cinema 4D">
                        <label class="tool-label cursor-pointer px-4 py-2 rounded-xl border-2 border-slate-200 bg-slate-50 font-bold text-sm text-slate-600 transition-all" for="mp_t6">ğŸ­ Cinema 4D</label>
                    </div>
                </div>

                <div class="mb-5">
                    <label class="block text-sm font-bold text-slate-700 mb-2">å˜ä¾¡ï¼ˆpriceï¼‰</label>
                    <input id="mpPrice" type="text" placeholder="ä¾‹ï¼šÂ¥3,000ã€œ"
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-cyan-400 focus:outline-none bg-slate-50 focus:bg-white transition-all">
                </div>

                <div class="mb-6">
                    <label class="block text-sm font-bold text-slate-700 mb-2">ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªURLï¼ˆimage_urlï¼‰</label>
                    <input id="mpImageUrl" type="url" placeholder="ä¾‹ï¼šhttps://example.com/avatar.jpg"
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:border-cyan-400 focus:outline-none bg-slate-50 focus:bg-white transition-all">
                </div>

                <div id="mypageError"   class="text-red-500   text-sm mb-3 hidden"></div>
                <div id="mypageSuccess" class="text-emerald-600 text-sm mb-3 hidden"></div>

                <button onclick="handleUpdate()"
                    class="w-full gradient-btn text-white py-4 rounded-2xl font-bold text-lg hover:opacity-90 hover:scale-[1.02] transition-all shadow-lg shadow-cyan-200">
                    ä¿å­˜ã™ã‚‹
                </button>
            </div>

            <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ -->
            <button onclick="handleLogout()"
                class="w-full bg-white text-slate-500 py-3 rounded-2xl font-bold border-2 border-slate-200 hover:border-red-300 hover:text-red-500 transition-all">
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
        </div>

    </main>

    <script>
        // ===== Supabaseè¨­å®š =====
        const SUPABASE_URL      = 'https://dwmgwdhunvanrsautvtj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR3bWd3ZGh1bnZhbnJzYXV0dnRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNzE1NzMsImV4cCI6MjA4NjY0NzU3M30.A7vam36zcqqwRcgE4ZFrnhiiJjzRpmt0Z3djYY-ixBo';

        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== èµ·å‹•ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª =====
        window.addEventListener('load', async () => {
            const { data: { session } } = await sb.auth.getSession();
            if (session) {
                await loadMypage(session.user);
            } else {
                showAuth();
            }
        });

        // ===== ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ =====
        function switchTab(tab) {
            const isLogin = tab === 'login';
            document.getElementById('loginForm').classList.toggle('hidden', !isLogin);
            document.getElementById('registerForm').classList.toggle('hidden', isLogin);
            document.getElementById('tabLogin').className    = isLogin
                ? 'flex-1 py-2.5 rounded-xl font-bold text-sm transition-all bg-white text-slate-800 shadow-sm'
                : 'flex-1 py-2.5 rounded-xl font-bold text-sm transition-all text-slate-500';
            document.getElementById('tabRegister').className = !isLogin
                ? 'flex-1 py-2.5 rounded-xl font-bold text-sm transition-all bg-white text-slate-800 shadow-sm'
                : 'flex-1 py-2.5 rounded-xl font-bold text-sm transition-all text-slate-500';
        }

        // ===== ãƒ­ã‚°ã‚¤ãƒ³ =====
        async function handleLogin() {
            const email    = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errEl    = document.getElementById('loginError');
            errEl.classList.add('hidden');

            if (!email || !password) { showErr(errEl, 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

            const { data, error } = await sb.auth.signInWithPassword({ email, password });
            if (error) { showErr(errEl, 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message); return; }
            await loadMypage(data.user);
        }

        // ===== æ–°è¦ç™»éŒ² =====
        async function handleRegister() {
            const email    = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const name     = document.getElementById('regName').value.trim();
            const errEl    = document.getElementById('registerError');
            errEl.classList.add('hidden');

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!email)    { showErr(errEl, 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            if (!password) { showErr(errEl, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            if (password.length < 6) { showErr(errEl, 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„'); return; }
            if (!name)     { showErr(errEl, 'ãŠåå‰ï¼ˆè¡¨ç¤ºåï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

            // â‘  Supabase Authã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
            const { data, error: authError } = await sb.auth.signUp({ email, password });
            if (authError) { showErr(errEl, 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + authError.message); return; }

            if (data.user) {
                // â‘¡ editorsãƒ†ãƒ¼ãƒ–ãƒ«ã®nameã‚«ãƒ©ãƒ ã«è¡¨ç¤ºåã‚’ä¿å­˜
                const { error: dbError } = await sb.from('editors').insert([{
                    id:    data.user.id,
                    name:  name,          // â† ãŠåå‰ï¼ˆè¡¨ç¤ºåï¼‰ã‚’ä¿å­˜
                    os:    null,
                    tools: [],
                    price: null,
                }]);

                if (dbError) {
                    console.error('editors insert error:', dbError);
                    // Authä½œæˆã¯æˆåŠŸã—ã¦ã„ã‚‹ã®ã§ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸é·ç§»
                    showErr(errEl, 'âš ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ä½œæˆã•ã‚Œã¾ã—ãŸãŒã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + dbError.message);
                }

                await loadMypage(data.user);

            } else {
                // ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ãªå ´åˆ
                errEl.classList.remove('hidden');
                errEl.className = 'text-emerald-600 text-sm mb-4';
                errEl.textContent = 'âœ… ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚';
            }
        }

        // ===== ãƒã‚¤ãƒšãƒ¼ã‚¸è¡¨ç¤º =====
        async function loadMypage(user) {
            showMypage();

            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è¡¨ç¤º
            document.getElementById('mypageEmail').textContent = user.email;

            // ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒã‚¤ãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯è¡¨ç¤º
            document.getElementById('headerNav').innerHTML = `
                <span class="text-sm text-slate-500">${user.email}</span>
                <button onclick="handleLogout()" class="text-sm text-red-400 font-bold hover:text-red-600 transition-colors">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            `;

            // editorsãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
            // auth.uid()::text = id::text ã§ã‚­ãƒ£ã‚¹ãƒˆã—ã¦å‹ä¸ä¸€è‡´ã‚’å›é¿
            const { data, error } = await sb
                .from('editors')
                .select('*')
                .filter('id::text', 'eq', user.id)
                .maybeSingle();

            console.log('mypage data:', data, 'error:', error);

            if (data) {
                document.getElementById('mypageName').textContent   = data.name || 'æœªè¨­å®š';
                document.getElementById('mpName').value             = data.name || '';
                document.getElementById('mpOs').value               = data.os   || '';
                document.getElementById('mpPrice').value            = data.price || '';
                document.getElementById('mpImageUrl').value         = data.image_url || '';

                // ã‚¢ãƒã‚¿ãƒ¼
                if (data.image_url) {
                    document.getElementById('mypageAvatarImg').src = data.image_url;
                } else {
                    document.getElementById('mypageAvatarImg').src =
                        `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(data.name || user.id)}`;
                }

                // ã‚½ãƒ•ãƒˆã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å¾©å…ƒ
                const tools = Array.isArray(data.tools) ? data.tools : [];
                document.querySelectorAll('.tool-checkbox').forEach(cb => {
                    cb.checked = tools.includes(cb.value);
                });
            } else {
                // ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆæ–°è¦ç™»éŒ²ç›´å¾Œãªã©ï¼‰
                document.getElementById('mypageName').textContent = 'æœªè¨­å®š';
                document.getElementById('mypageAvatarImg').src =
                    `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.id}`;
            }
        }

        // ===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–° =====
        async function handleUpdate() {
            const errEl  = document.getElementById('mypageError');
            const sucEl  = document.getElementById('mypageSuccess');
            errEl.classList.add('hidden');
            sucEl.classList.add('hidden');

            const name  = document.getElementById('mpName').value.trim();
            const os    = document.getElementById('mpOs').value;
            const price = document.getElementById('mpPrice').value.trim();
            const imageUrl = document.getElementById('mpImageUrl').value.trim();
            const tools = Array.from(document.querySelectorAll('.tool-checkbox:checked')).map(c => c.value);

            if (!name)  { showErr(errEl, 'ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            if (!os)    { showErr(errEl, 'ä½¿ç”¨OSã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            if (tools.length === 0) { showErr(errEl, 'ä½¿ç”¨ã‚½ãƒ•ãƒˆã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„'); return; }

            const { data: { user } } = await sb.auth.getUser();
            if (!user) { showErr(errEl, 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„'); return; }

            // auth.uid()::text = id::text ã§ã‚­ãƒ£ã‚¹ãƒˆã—ã¦æ›´æ–°
            const { error } = await sb
                .from('editors')
                .update({
                    name:      name,
                    os:        os,
                    tools:     tools,
                    price:     price     || null,
                    image_url: imageUrl  || null,
                })
                .filter('id::text', 'eq', user.id);

            if (error) {
                console.error('update error:', error);
                showErr(errEl, 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸï¼š' + error.message);
                return;
            }

            // è¡¨ç¤ºåãƒ»ã‚¢ãƒã‚¿ãƒ¼ã‚’å³æ™‚æ›´æ–°
            document.getElementById('mypageName').textContent = name;
            if (imageUrl) document.getElementById('mypageAvatarImg').src = imageUrl;

            sucEl.textContent = 'âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼';
            sucEl.classList.remove('hidden');
            setTimeout(() => sucEl.classList.add('hidden'), 3000);
        }

        // ===== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =====
        async function handleLogout() {
            await sb.auth.signOut();
            document.getElementById('headerNav').innerHTML = '';
            showAuth();
        }

        // ===== UIåˆ‡ã‚Šæ›¿ãˆãƒ˜ãƒ«ãƒ‘ãƒ¼ =====
        function showAuth() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mypageSection').classList.add('hidden');
        }
        function showMypage() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mypageSection').classList.remove('hidden');
        }
        function showErr(el, msg) {
            el.textContent = 'âš ï¸ ' + msg;
            el.classList.remove('hidden');
        }
    </script>
</body>
</html>
