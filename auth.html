<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shorts Match - ãƒ­ã‚°ã‚¤ãƒ³ / ãƒã‚¤ãƒšãƒ¼ã‚¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); }
        .gradient-btn { background: linear-gradient(to right, #06b6d4, #3b82f6); }
        .fade-in { animation: fadeIn 0.4s ease both; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .slide-down { animation: slideDown 0.4s ease both; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to   { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm">
        <div class="max-w-5xl mx-auto px-6 py-4 flex items-center justify-between">
            <!-- ãƒ­ã‚´ï¼ˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸ã®å°ç·šï¼‰ -->
            <a href="index.html" class="flex items-center gap-2 group">
                <div class="w-8 h-8 gradient-btn rounded-lg flex items-center justify-center text-white text-sm font-bold shadow group-hover:scale-110 transition-transform">â–¶</div>
                <span class="font-black text-xl text-cyan-600 group-hover:text-cyan-500 transition-colors">Shorts Match</span>
            </a>
            <!-- ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ -->
            <a href="index.html"
               class="flex items-center gap-1.5 text-sm font-bold text-slate-500 hover:text-cyan-600 transition-colors px-4 py-2 rounded-xl hover:bg-cyan-50">
                â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸
            </a>
        </div>
    </header>

    <main class="max-w-md mx-auto px-6 py-12">

        <!-- ===== ãƒ­ã‚°ã‚¤ãƒ³ / æ–°è¦ç™»éŒ² ===== -->
        <div id="authSection" class="fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 gradient-btn rounded-2xl flex items-center justify-center text-white text-2xl mx-auto mb-4 shadow-lg shadow-cyan-200">âœï¸</div>
                <h1 class="text-3xl font-black text-slate-800 mb-2">ç·¨é›†è€…ãƒãƒ¼ã‚¿ãƒ«</h1>
                <p class="text-slate-500">ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯æ–°è¦ç™»éŒ²ã‚’ã—ã¦ãã ã•ã„</p>
            </div>

            <div class="bg-white rounded-3xl shadow-xl p-8">
                <!-- ã‚¿ãƒ– -->
                <div class="flex rounded-2xl bg-slate-100 p-1 mb-8">
                    <button id="tabLogin"
                        onclick="switchTab('login')"
                        class="flex-1 py-2.5 rounded-xl font-bold text-sm transition-all bg-white text-slate-800 shadow-sm">
                        ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                    <button id="tabRegister"
                        onclick="switchTab('register')"
                        class="flex-1 py-2.5 rounded-xl font-bold text-sm transition-all text-slate-500">
                        æ–°è¦ç™»éŒ²
                    </button>
                </div>

                <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="loginForm" class="space-y-4">
                    <input id="loginEmail" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl outline-none focus:border-cyan-400 bg-slate-50 transition-all">
                    <input id="loginPassword" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl outline-none focus:border-cyan-400 bg-slate-50 transition-all">
                    <div id="loginMsg" class="hidden text-sm font-bold px-4 py-3 rounded-xl"></div>
                    <button onclick="handleLogin()"
                        class="w-full gradient-btn text-white py-4 rounded-2xl font-bold text-base shadow-lg shadow-cyan-200 hover:scale-[1.02] hover:opacity-90 transition-all">
                        ãƒ­ã‚°ã‚¤ãƒ³
                    </button>
                </div>

                <!-- æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="registerForm" class="hidden space-y-4">
                    <!-- ãŠåå‰ï¼ˆè¡¨ç¤ºåï¼‰- ç›®ç«‹ã¤ä½ç½®ã«é…ç½® -->
                    <div>
                        <input id="regName" type="text" placeholder="ãŠåå‰ï¼ˆè¡¨ç¤ºåï¼‰"
                            class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl outline-none focus:border-cyan-400 bg-slate-50 transition-all">
                        <p class="text-xs text-slate-400 mt-1.5 px-1">âœ¦ ç·¨é›†è€…ä¸€è¦§ã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤ºã•ã‚Œã‚‹åå‰ã§ã™</p>
                    </div>
                    <input id="regEmail" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl outline-none focus:border-cyan-400 bg-slate-50 transition-all">
                    <input id="regPassword" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ6æ–‡å­—ä»¥ä¸Šï¼‰"
                        class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl outline-none focus:border-cyan-400 bg-slate-50 transition-all">
                    <div id="registerMsg" class="hidden text-sm font-bold px-4 py-3 rounded-xl"></div>
                    <button onclick="handleRegister()"
                        class="w-full gradient-btn text-white py-4 rounded-2xl font-bold text-base shadow-lg shadow-cyan-200 hover:scale-[1.02] hover:opacity-90 transition-all">
                        ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ
                    </button>
                </div>
            </div>
        </div>

        <!-- ===== ãƒã‚¤ãƒšãƒ¼ã‚¸ ===== -->
        <div id="mypageSection" class="hidden fade-in space-y-6">
            <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="text-center">
                <div class="w-20 h-20 gradient-btn rounded-2xl mx-auto mb-4 flex items-center justify-center text-white text-4xl shadow-lg shadow-cyan-200">
                    ğŸ‘¤
                </div>
                <h1 class="text-2xl font-black text-slate-800" id="mypageName">èª­ã¿è¾¼ã¿ä¸­...</h1>
                <p class="text-cyan-600 font-bold text-sm mt-1" id="mypageEmail"></p>
            </div>

            <!-- ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="bg-white rounded-3xl shadow-xl p-8 space-y-5">
                <h2 class="text-lg font-bold text-slate-800 border-b border-slate-100 pb-4">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h2>

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 px-1">è¡¨ç¤ºå <span class="text-red-400">*</span></label>
                    <input type="text" id="mpName" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ"
                        class="w-full p-4 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-cyan-400 outline-none transition-all">
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-2 px-1">å˜ä¾¡ç›®å®‰</label>
                    <input type="text" id="mpPrice" placeholder="ä¾‹ï¼šÂ¥3,000ã€œ"
                        class="w-full p-4 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-cyan-400 outline-none transition-all">
                </div>

                <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <div id="mypageStatus" class="hidden text-sm font-bold px-4 py-3 rounded-xl text-center"></div>

                <button onclick="handleUpdate()"
                    class="w-full gradient-btn text-white py-4 rounded-2xl font-bold shadow-lg shadow-cyan-200 hover:scale-[1.02] hover:opacity-90 transition-all">
                    ä¿å­˜ã™ã‚‹
                </button>
            </div>

            <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ -->
            <button onclick="handleLogout()"
                class="w-full bg-white text-slate-400 py-4 rounded-2xl font-bold border-2 border-slate-100 hover:text-red-500 hover:border-red-100 transition-all">
                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
            </button>
        </div>

    </main>

    <script>
        // ===== Supabaseè¨­å®š =====
        const SUPABASE_URL = 'https://dwmgwdhunvanrsautvtj.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_GzaEGCWBP7y0za2UVPiJNA_N3pdlgJ0';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ===== èµ·å‹•ï¼šã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª =====
        window.addEventListener('load', async () => {
            const { data: { session } } = await sb.auth.getSession();
            if (session) {
                await loadMypage(session.user);
            } else {
                showAuth();
            }
        });

        // ===== ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ =====
        function switchTab(tab) {
            const isLogin = tab === 'login';
            document.getElementById('loginForm').classList.toggle('hidden', !isLogin);
            document.getElementById('registerForm').classList.toggle('hidden', isLogin);
            document.getElementById('tabLogin').className = isLogin
                ? 'flex-1 py-2.5 rounded-xl font-bold text-sm transition-all bg-white text-slate-800 shadow-sm'
                : 'flex-1 py-2.5 rounded-xl font-bold text-sm transition-all text-slate-500';
            document.getElementById('tabRegister').className = !isLogin
                ? 'flex-1 py-2.5 rounded-xl font-bold text-sm transition-all bg-white text-slate-800 shadow-sm'
                : 'flex-1 py-2.5 rounded-xl font-bold text-sm transition-all text-slate-500';
        }

        // ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºãƒ˜ãƒ«ãƒ‘ãƒ¼ =====
        function showMsg(elId, msg, type) {
            const el = document.getElementById(elId);
            const styles = {
                error:   'bg-red-50 text-red-600 border border-red-200',
                success: 'bg-emerald-50 text-emerald-600 border border-emerald-200',
                info:    'bg-cyan-50 text-cyan-600 border border-cyan-200',
            };
            el.className = `text-sm font-bold px-4 py-3 rounded-xl slide-down ${styles[type] || styles.info}`;
            el.textContent = msg;
            el.classList.remove('hidden');
        }
        function hideMsg(elId) {
            document.getElementById(elId).classList.add('hidden');
        }

        // ===== ãƒ­ã‚°ã‚¤ãƒ³ =====
        async function handleLogin() {
            const email    = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            hideMsg('loginMsg');

            if (!email || !password) {
                showMsg('loginMsg', 'âš ï¸ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            showMsg('loginMsg', 'â³ ãƒ­ã‚°ã‚¤ãƒ³ä¸­...', 'info');

            const { data, error } = await sb.auth.signInWithPassword({ email, password });
            if (error) {
                showMsg('loginMsg', 'âŒ ' + error.message, 'error');
                return;
            }

            // âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ â†’ ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸é·ç§»
            showMsg('loginMsg', 'âœ… ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¾ã™', 'success');
            setTimeout(async () => {
                await loadMypage(data.user);
            }, 1000);
        }

        // ===== æ–°è¦ç™»éŒ² =====
        async function handleRegister() {
            const name     = document.getElementById('regName').value.trim();
            const email    = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            hideMsg('registerMsg');

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!name)               { showMsg('registerMsg', 'âš ï¸ ãŠåå‰ï¼ˆè¡¨ç¤ºåï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
            if (!email)              { showMsg('registerMsg', 'âš ï¸ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }
            if (password.length < 6) { showMsg('registerMsg', 'âš ï¸ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„', 'error'); return; }

            showMsg('registerMsg', 'â³ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆä¸­...', 'info');

            // â‘  Supabase Authã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
            const { data, error } = await sb.auth.signUp({ email, password });
            if (error) {
                showMsg('registerMsg', 'âŒ ' + error.message, 'error');
                return;
            }

            if (data.user) {
                // â‘¡ editorsãƒ†ãƒ¼ãƒ–ãƒ«ã«nameï¼ˆè¡¨ç¤ºåï¼‰ã‚’ä¿å­˜
                // id ã‚’æ˜ç¤ºçš„ã«å«ã‚ã¦upsertã—ã€UUIDã¨Bigintã®å‹ä¸ä¸€è‡´ã‚’é˜²ã
                const { error: dbError } = await sb.from('editors').upsert({
                    id:   data.user.id,   // UUIDã‚’ãã®ã¾ã¾æ¸¡ã™
                    name: name,
                }, { onConflict: 'id' });

                if (dbError) {
                    console.error('editors upsert error:', dbError);
                    // Authä½œæˆã¯æˆåŠŸã—ã¦ã„ã‚‹ã®ã§è­¦å‘Šã®ã¿
                    showMsg('registerMsg', 'âš ï¸ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ä½œæˆã—ã¾ã—ãŸãŒã€åå‰ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                } else {
                    // âœ… æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ â†’ 2ç§’å¾Œã«ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸è‡ªå‹•é·ç§»
                    showMsg('registerMsg', 'âœ… ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼ãƒã‚¤ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¾ã™', 'success');
                    setTimeout(async () => {
                        await loadMypage(data.user);
                    }, 2000);
                }
            } else {
                // ãƒ¡ãƒ¼ãƒ«ç¢ºèªãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹
                showMsg('registerMsg', 'ğŸ“© ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚', 'info');
            }
        }

        // ===== ãƒã‚¤ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ =====
        async function loadMypage(user) {
            showMypage();
            document.getElementById('mypageEmail').textContent = user.email;

            const { data, error } = await sb
                .from('editors')
                .select('*')
                .filter('id::text', 'eq', user.id)   // auth.uid()::text = id::text ã§ã‚­ãƒ£ã‚¹ãƒˆ
                .maybeSingle();

            console.log('[mypage] data:', data, 'error:', error);

            if (data) {
                document.getElementById('mypageName').textContent = data.name  || 'æœªè¨­å®š';
                document.getElementById('mpName').value           = data.name  || '';
                document.getElementById('mpPrice').value          = data.price || '';
            } else {
                document.getElementById('mypageName').textContent = 'æœªè¨­å®š';
            }
        }

        // ===== ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–° =====
        async function handleUpdate() {
            const statusEl = document.getElementById('mypageStatus');
            hideMsg('mypageStatus');

            const name  = document.getElementById('mpName').value.trim();
            const price = document.getElementById('mpPrice').value.trim();

            if (!name) { showMsg('mypageStatus', 'âš ï¸ è¡¨ç¤ºåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error'); return; }

            showMsg('mypageStatus', 'â³ ä¿å­˜ä¸­...', 'info');

            const { data: { user } } = await sb.auth.getUser();
            if (!user) { showMsg('mypageStatus', 'âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„', 'error'); return; }

            // id ã‚’å«ã‚ã¦upsertï¼ˆå‹ä¸ä¸€è‡´ã‚’é˜²ããŸã‚ã«idã‚’æ˜ç¤ºï¼‰
            const { error } = await sb.from('editors').upsert({
                id:    user.id,
                name:  name,
                price: price || null,
            }, { onConflict: 'id' });

            if (error) {
                console.error('update error:', error);
                showMsg('mypageStatus', 'âŒ ã‚¨ãƒ©ãƒ¼ï¼š' + error.message, 'error');
                return;
            }

            document.getElementById('mypageName').textContent = name;
            showMsg('mypageStatus', 'âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
            setTimeout(() => hideMsg('mypageStatus'), 3000);
        }

        // ===== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ =====
        async function handleLogout() {
            await sb.auth.signOut();
            showAuth();
        }

        // ===== UIåˆ‡ã‚Šæ›¿ãˆ =====
        function showAuth() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mypageSection').classList.add('hidden');
        }
        function showMypage() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('mypageSection').classList.remove('hidden');
        }
    </script>
</body>
</html>
